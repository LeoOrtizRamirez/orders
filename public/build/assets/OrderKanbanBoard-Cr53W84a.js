import{V as Ae}from"./vue-draggable-next.esm-bundler-DWdGXwbi.js";import{b as ce,d as V,_ as Pe,c as Ne,u as Ue}from"./main-JT-dYQ3z.js";import{S as le}from"./sweetalert2.esm.all-5zhdP7Ax.js";import{r as j,c as K,d as ue,k as u,x as C,l as c,m as e,t,H as de,A as T,K as Le,n as R,F as N,D as U,a2 as F,y as z,J as Te,f as q,q as D,u as f,I as Ve,z as Re,w as ke,o as ze,G as He,E as Ke}from"./vendor-CjqaLWPm.js";import{M as je}from"./vue3-multiselect-BDWUPkFk.js";import{Y as qe,h as ie,_ as Me,G as Ee,S as De}from"./transition-CBBt4QPa.js";import{_ as Fe}from"./AlertMessages.vue_vue_type_script_setup_true_lang-CV0GMxpE.js";import"./quill-De1S0mUZ.js";import"./hidden-EHDRiAGA.js";import"./keyboard-DucK85rM.js";import"./open-closed-CzbEUxkg.js";function Ge(){const{t:m}=ce(),v=j([]),O=j([]),$=j([]),M=j(!1),E=j(!1),y=j(""),B=j(""),I=j({}),A=j(""),a=j({show:!1,data:null}),k=j(null),S=j({status:"",supplier_id:""}),l={id:null,supplier_id:null,expected_delivery_date:null,notes:"",items:[]},r=j({...l}),d=K(()=>{let s=v.value;if(A.value){const o=A.value.toLowerCase();s=s.filter(n=>{var i,p,w;return((i=n.order_number)==null?void 0:i.toLowerCase().includes(o))||((w=(p=n.supplier)==null?void 0:p.name)==null?void 0:w.toLowerCase().includes(o))})}return S.value.status&&(s=s.filter(o=>o.status===S.value.status)),S.value.supplier_id&&(s=s.filter(o=>o.supplier_id===parseInt(S.value.supplier_id))),s}),g=K(()=>v.value.length),_=K(()=>v.value.filter(s=>s.status==="pending").length),b=K(()=>v.value.filter(s=>s.status==="approved").length),W=K(()=>v.value.filter(s=>s.status==="ordered").length),X=K(()=>v.value.filter(s=>s.status==="received").length),H=async()=>{M.value=!0,y.value="";try{const s=new URLSearchParams;S.value.status&&s.append("status",S.value.status),S.value.supplier_id&&s.append("supplier_id",S.value.supplier_id);const o=await V.get(`/api/purchase-orders?${s}`);Array.isArray(o.data)?v.value=o.data:o.data&&Array.isArray(o.data.data)?v.value=o.data.data:o.data&&Array.isArray(o.data.orders)?v.value=o.data.orders:(console.warn("Estructura de respuesta inesperada:",o.data),v.value=[])}catch(s){console.error("Error fetching orders:",s),y.value=m("purchase_orders_page.alerts.loading_error"),x(m("purchase_orders_page.alerts.loading_error"),"error")}finally{M.value=!1}},Z=async()=>{try{const s=await V.get("/api/suppliers/for-select");Array.isArray(s.data)?O.value=s.data:s.data&&Array.isArray(s.data.data)?O.value=s.data.data:(console.warn("Estructura de respuesta inesperada para suppliers:",s.data),O.value=[])}catch(s){console.error("Error fetching suppliers:",s),O.value=[]}},pe=async()=>{try{const s=await V.get("/api/products/active/list");Array.isArray(s.data)?$.value=s.data:s.data&&Array.isArray(s.data.data)?$.value=s.data.data:(console.warn("Estructura de respuesta inesperada para products:",s.data),$.value=[])}catch(s){console.error("Error fetching products:",s),$.value=[]}},ae=s=>s&&$.value.find(o=>o.id===s)||null,ee=(s,o)=>{if(!s)return{valid:!1,message:"Producto no seleccionado"};const n=ae(s);if(!n)return{valid:!1,message:"Producto no encontrado"};const i=n.current_stock||0;return o>i?{valid:!1,message:`Stock insuficiente. Stock disponible: ${i}`}:{valid:!0,message:""}},_e=async()=>{E.value=!0,I.value={},y.value="",B.value="";try{let s;r.value.id?s=await V.put(`/api/purchase-orders/${r.value.id}`,r.value):s=await V.post("/api/purchase-orders",r.value);const o=s.data.data||s.data;if(r.value.id){const n=v.value.findIndex(i=>i.id===r.value.id);n!==-1&&v.value.splice(n,1,o),x(m("purchase_orders_page.alerts.update_success"))}else v.value.unshift(o),x(m("purchase_orders_page.alerts.save_success"));return!0}catch(s){return s.response&&s.response.status===422?(I.value=s.response.data.errors,y.value=m("purchase_orders_page.alerts.validation_errors")):(console.error("Error saving order:",s),y.value=m("purchase_orders_page.alerts.save_error"),x(m("purchase_orders_page.alerts.save_error"),"error")),!1}finally{E.value=!1}},se=async s=>{var n;if(!s.can_be_deleted)return x(m("purchase_orders_page.alerts.cannot_delete"),"error"),!1;if((await le.fire({title:m("purchase_orders_page.delete_confirm.title"),text:m("purchase_orders_page.delete_confirm.text"),icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:m("purchase_orders_page.delete_confirm.confirm"),cancelButtonText:m("purchase_orders_page.delete_confirm.cancel")})).isConfirmed)try{return await V.delete(`/api/purchase-orders/${s.id}`),v.value=v.value.filter(i=>i.id!==s.id),x(m("purchase_orders_page.alerts.delete_success")),!0}catch(i){return console.error("Error deleting order:",i),((n=i.response)==null?void 0:n.status)===400?x(i.response.data.message,"error"):x(m("purchase_orders_page.alerts.delete_error"),"error"),!1}return!1},te=async s=>{var o,n;try{const i=await V.post(`/api/purchase-orders/${s.id}/submit`);if(i.data.success){const p=v.value.findIndex(w=>w.id===s.id);return p!==-1&&v.value.splice(p,1,i.data.order),x(m("purchase_orders_page.alerts.submit_success")),!0}else return x(i.data.message||m("purchase_orders_page.alerts.save_error"),"error"),!1}catch(i){console.error("Error submitting order:",i);const p=((n=(o=i.response)==null?void 0:o.data)==null?void 0:n.message)||m("purchase_orders_page.alerts.save_error");return x(p,"error"),!1}},Q=async s=>{var o,n;try{const i=await V.post(`/api/purchase-orders/${s.id}/approve`);if(i.data.success){const p=v.value.findIndex(w=>w.id===s.id);return p!==-1&&v.value.splice(p,1,i.data.order),x(m("purchase_orders_page.alerts.approve_success")),!0}else return x(i.data.message||m("purchase_orders_page.alerts.save_error"),"error"),!1}catch(i){console.error("Error approving order:",i);const p=((n=(o=i.response)==null?void 0:o.data)==null?void 0:n.message)||m("purchase_orders_page.alerts.save_error");return x(p,"error"),!1}},L=async s=>{var n,i;const{value:o}=await le.fire({title:m("purchase_orders_page.reject_confirm.title"),input:"textarea",inputLabel:m("purchase_orders_page.reject_confirm.input_label"),inputPlaceholder:m("purchase_orders_page.reject_confirm.input_placeholder"),inputAttributes:{"aria-label":m("purchase_orders_page.reject_confirm.input_label")},showCancelButton:!0,confirmButtonText:m("purchase_orders_page.reject_confirm.confirm"),cancelButtonText:m("purchase_orders_page.reject_confirm.cancel"),inputValidator:p=>p?null:m("purchase_orders_page.reject_confirm.input_required")});if(o)try{const p=await V.post(`/api/purchase-orders/${s.id}/reject`,{rejection_reason:o});if(p.data.success){const w=v.value.findIndex(J=>J.id===s.id);return w!==-1&&v.value.splice(w,1,p.data.order),x(m("purchase_orders_page.alerts.reject_success")),!0}else return x(p.data.message||m("purchase_orders_page.alerts.save_error"),"error"),!1}catch(p){console.error("Error rejecting order:",p);const w=((i=(n=p.response)==null?void 0:n.data)==null?void 0:i.message)||m("purchase_orders_page.alerts.save_error");return x(w,"error"),!1}return!1},P=async s=>{var o,n;try{const i=await V.post(`/api/purchase-orders/${s.id}/mark-ordered`);if(i.data.success){const p=v.value.findIndex(w=>w.id===s.id);return p!==-1&&v.value.splice(p,1,i.data.order),x(m("purchase_orders_page.alerts.mark_ordered_success")),!0}else return x(i.data.message||m("purchase_orders_page.alerts.save_error"),"error"),!1}catch(i){console.error("Error marking order as ordered:",i);const p=((n=(o=i.response)==null?void 0:o.data)==null?void 0:n.message)||m("purchase_orders_page.alerts.save_error");return x(p,"error"),!1}},me=async s=>{var o,n;try{const i=await V.post(`/api/purchase-orders/${s.id}/receive`);if(i.data.success){const p=v.value.findIndex(w=>w.id===s.id);return p!==-1&&v.value.splice(p,1,i.data.order),x(m("purchase_orders_page.alerts.receive_success")),!0}else return x(i.data.message||m("purchase_orders_page.alerts.save_error"),"error"),!1}catch(i){console.error("Error receiving order:",i);const p=((n=(o=i.response)==null?void 0:o.data)==null?void 0:n.message)||m("purchase_orders_page.alerts.save_error");return x(p,"error"),!1}},he=async s=>{var n,i;const{value:o}=await le.fire({title:m("purchase_orders_page.cancel_confirm.title"),input:"textarea",inputLabel:m("purchase_orders_page.cancel_confirm.input_label"),inputPlaceholder:m("purchase_orders_page.cancel_confirm.input_placeholder"),showCancelButton:!0,confirmButtonText:m("purchase_orders_page.cancel_confirm.confirm"),cancelButtonText:m("purchase_orders_page.cancel_confirm.cancel")});if(o!==void 0)try{const p=await V.post(`/api/purchase-orders/${s.id}/cancel`,{reason:o||null});if(p.data.success){const w=v.value.findIndex(J=>J.id===s.id);return w!==-1&&v.value.splice(w,1,p.data.order),x(m("purchase_orders_page.alerts.cancel_success")),!0}else return x(p.data.message||m("purchase_orders_page.alerts.save_error"),"error"),!1}catch(p){console.error("Error canceling order:",p);const w=((i=(n=p.response)==null?void 0:n.data)==null?void 0:i.message)||m("purchase_orders_page.alerts.save_error");return x(w,"error"),!1}return!1},ge=async s=>{var o,n;try{const i=await V.post(`/api/purchase-orders/${s.id}/reopen`);if(i.data.success){const p=v.value.findIndex(w=>w.id===s.id);return p!==-1&&v.value.splice(p,1,i.data.order),x(m("purchase_orders_page.alerts.reopen_success")),!0}else return x(i.data.message||m("purchase_orders_page.alerts.save_error"),"error"),!1}catch(i){console.error("Error reopening order:",i);const p=((n=(o=i.response)==null?void 0:o.data)==null?void 0:n.message)||m("purchase_orders_page.alerts.save_error");return x(p,"error"),!1}},ve=async(s,o)=>{E.value=!0,I.value={},y.value="",B.value="";try{const n=await V.post(`/api/purchase-orders/${s}/split`,o);return n.data?(await H(),x(m("purchase_orders_page.alerts.split_success")),!0):(x(n.data.message||m("purchase_orders_page.alerts.split_error"),"error"),!1)}catch(n){return n.response&&n.response.status===422?(I.value=n.response.data.errors,y.value=m("purchase_orders_page.alerts.validation_errors")):(console.error("Error splitting order:",n),y.value=m("purchase_orders_page.alerts.split_error"),x(m("purchase_orders_page.alerts.split_error"),"error")),!1}finally{E.value=!1}},Y=async s=>{M.value=!0;try{return(await V.get(`/api/purchase-orders/${s}`)).data}catch(o){return console.error("Error fetching order details:",o),x(m("purchase_orders_page.alerts.loading_error"),"error"),null}finally{M.value=!1}},fe=async(s=null)=>{var o;if(I.value={},s){const n=await Y(s.id);if(!n)return;k.value=n.notes;const i=n.expected_delivery_date?new Date(n.expected_delivery_date).toISOString().split("T")[0]:null;r.value={id:n.id,supplier_id:n.supplier_id,expected_delivery_date:i,items:((o=n.items)==null?void 0:o.map(p=>({id:p.id,product_id:p.product_id,quantity:p.quantity,itemNotes:p.item_notes||[],notes:"",checked:p.checked??!1})))||[]}}else k.value=null,r.value={...l,items:[re()]}},ye=()=>{r.value={...l},k.value=null,I.value={}},re=()=>({product_id:null,quantity:1,itemNotes:[],checked:!1}),oe=()=>{r.value.items.push(re())},be=s=>{r.value.items.splice(s,1),r.value.items.length===0&&oe()},ne=s=>({draft:"bg-gray-100 text-gray-800",pending:"bg-warning/10 text-warning",approved:"bg-success/10 text-success",rejected:"bg-danger/10 text-danger",ordered:"bg-info/10 text-info",received:"bg-secondary/10 text-secondary",cancelled:"bg-danger/10 text-danger"})[s]||"bg-gray-100 text-gray-800",x=(s="",o="success")=>{o==="success"?B.value=s:y.value=s,le.mixin({toast:!0,position:"top",showConfirmButton:!1,timer:3e3}).fire({icon:o,title:s,padding:"10px 20px"})};return{ordersList:v,suppliers:O,products:$,loading:M,saving:E,errorMessage:y,successMessage:B,errors:I,searchOrder:A,filters:S,params:r,viewModal:a,orderNotes:k,filteredOrdersList:d,totalOrders:g,pendingOrders:_,approvedOrders:b,orderedOrders:W,receivedOrders:X,fetchOrders:H,fetchSuppliers:Z,fetchProducts:pe,getProductInfo:ae,validateQuantity:ee,saveOrder:_e,deleteOrder:se,submitOrder:te,approveOrder:Q,rejectOrder:L,markAsOrdered:P,receiveOrder:me,cancelOrder:he,reopenOrder:ge,editOrder:fe,resetParams:ye,addItem:oe,removeItem:be,getStatusClass:ne,showMessage:x,formatDate:s=>s?new Date(s).toLocaleDateString("es-ES"):"-",viewOrder:async s=>{a.value={show:!0,data:null};const o=await Y(s);o?a.value.data=o:a.value.show=!1},refreshViewOrderData:async s=>{const o=await Y(s);o&&(a.value.data=o)},closeViewModal:()=>{a.value={show:!1,data:null}},splitOrder:ve}}const Qe={key:0,class:"fixed inset-0 bg-[black]/60 z-50 overflow-y-auto"},Ye={class:"flex items-start justify-center min-h-screen px-4"},Je={class:"panel border-0 p-0 rounded-lg overflow-hidden w-full max-w-6xl my-8"},We={class:"flex bg-[#fbfbfb] dark:bg-[#1c232f] items-center justify-between px-5 py-3"},Xe={class:"font-bold text-lg"},Ze={class:"p-5"},es={class:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-5"},ss={for:"supplier",class:"form-label"},ts={value:""},rs=["value"],as={key:0,class:"text-danger mt-1 text-xs"},os={for:"expected_delivery_date",class:"form-label"},ns={key:0,class:"text-danger mt-1 text-xs"},ls={class:"mb-5"},ds={class:"flex justify-between items-center mb-3"},is={class:"form-label"},cs={class:"space-y-4"},us={class:"flex flex-col gap-3"},ps={class:"flex items-start gap-3"},_s={class:"pt-2"},ms=["onUpdate:modelValue"],hs={class:"flex-grow"},gs={class:"flex justify-between items-center w-full"},vs={key:0,class:"text-danger text-xs font-bold ml-2"},fs={key:1,class:"text-success text-xs ml-2"},ys={class:"flex items-center"},bs={key:0,class:"text-gray-500 text-xs ml-2"},ws={key:0,class:"text-danger mt-1 text-xs"},xs={class:"w-24"},ks=["onUpdate:modelValue","onInput"],$s=["onClick"],Cs={class:"pl-8"},Os={key:0,class:"text-danger text-xs mb-1"},Ss={class:"pl-8"},Is={key:0,class:"bg-gray-100 dark:bg-gray-700 p-2 rounded space-y-2 max-h-24 overflow-y-auto mb-2"},Vs={class:"font-semibold"},js={class:"text-gray-500 text-xs"},qs={class:"text-gray-600 dark:text-gray-300 whitespace-pre-wrap"},Ms=["placeholder","onUpdate:modelValue"],Es={class:"mb-5"},Ds={class:"form-label font-semibold"},Bs={class:"bg-gray-50 dark:bg-gray-800 p-3 rounded space-y-3 mb-3"},As={class:"font-semibold"},Ps={class:"text-gray-500 text-xs"},Ns={class:"text-gray-600 dark:text-gray-300 whitespace-pre-wrap"},Us={key:0,class:"text-gray-500"},Ls={for:"notes",class:"form-label text-xs"},Ts=["placeholder"],Rs={class:"flex justify-end items-center mt-8 border-t pt-4"},zs=["disabled"],Hs=["disabled"],Ks={key:0,class:"flex items-center"},Fs={key:1},Gs=ue({__name:"PurchaseOrderModal",props:{show:{type:Boolean},params:{},errors:{},saving:{type:Boolean},suppliers:{},products:{},existingOrderNotes:{}},emits:["close","save","add-item","remove-item","refresh-view-order"],setup(m,{emit:v}){const{t:O}=ce(),$=m,M=v,E=K(()=>$.products.filter(l=>l.is_active!==!1)),y=K(()=>{const l=$.params.items.length>0&&$.params.items.every(r=>r.product_id&&r.quantity>0);return $.params.supplier_id&&$.params.expected_delivery_date&&l}),B=(l,r)=>{r===""||r===null||r<0&&($.params.items[l].quantity=0)},I=l=>{if(!l)return 0;const r=$.products.find(d=>d.id===l);return(r==null?void 0:r.stock)||0},A=l=>l&&$.products.find(r=>r.id===l)||null,a=l=>{if(!l)return"";const r=$.products.find(d=>d.id===l);return r?r.stock===0?"text-danger":r.stock<=(r.reorder_point||0)?"text-warning":"text-success":""},k=l=>l?new Date(l).toLocaleDateString("es-ES",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"-",S=()=>{console.log("PurchaseOrderModal: Emitting close event"),M("close")};return(l,r)=>l.show?(c(),u("div",Qe,[e("div",Ye,[e("div",Je,[e("div",We,[e("h5",Xe,t(l.params.id?l.$t("purchase_orders_page.create_modal.edit_title"):l.$t("purchase_orders_page.create_modal.add_title")),1),e("button",{type:"button",class:"text-white-dark hover:text-dark",onClick:r[0]||(r[0]=d=>S())},[...r[7]||(r[7]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"w-6 h-6"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])])]),e("div",Ze,[e("form",{onSubmit:r[6]||(r[6]=de(d=>l.$emit("save",l.params),["prevent"]))},[e("div",es,[e("div",null,[e("label",ss,t(l.$t("purchase_orders_page.create_modal.fields.supplier"))+" * ",1),T(e("select",{id:"supplier","onUpdate:modelValue":r[1]||(r[1]=d=>l.params.supplier_id=d),class:R(["form-select",{"border-danger":l.errors.supplier_id}]),required:""},[e("option",ts,t(l.$t("purchase_orders_page.create_modal.placeholders.select_supplier")),1),(c(!0),u(N,null,U(l.suppliers,d=>(c(),u("option",{key:d.id,value:d.id},t(d.name),9,rs))),128))],2),[[Le,l.params.supplier_id]]),l.errors.supplier_id?(c(),u("div",as,t(l.errors.supplier_id[0]),1)):C("",!0)]),e("div",null,[e("label",os,t(l.$t("purchase_orders_page.create_modal.fields.expected_delivery_date"))+" * ",1),T(e("input",{id:"expected_delivery_date",type:"date","onUpdate:modelValue":r[2]||(r[2]=d=>l.params.expected_delivery_date=d),class:R(["form-input",{"border-danger":l.errors.expected_delivery_date}]),required:""},null,2),[[F,l.params.expected_delivery_date]]),l.errors.expected_delivery_date?(c(),u("div",ns,t(l.errors.expected_delivery_date[0]),1)):C("",!0)])]),e("div",ls,[e("div",ds,[e("label",is,t(l.$t("purchase_orders_page.create_modal.fields.items"))+" * ",1),e("button",{type:"button",class:"btn btn-primary btn-sm",onClick:r[3]||(r[3]=d=>l.$emit("add-item"))}," + "+t(l.$t("purchase_orders_page.create_modal.buttons.add_item")),1)]),e("div",cs,[(c(!0),u(N,null,U(l.params.items,(d,g)=>(c(),u("div",{key:g,class:"border border-[#e0e6ed] dark:border-[#1b2e4b] rounded p-4 bg-gray-50 dark:bg-[#1a2234]"},[e("div",us,[e("div",ps,[e("div",_s,[T(e("input",{type:"checkbox",class:"form-checkbox w-5 h-5","onUpdate:modelValue":_=>d.checked=_},null,8,ms),[[Te,d.checked]])]),e("div",hs,[q(f(je),{"model-value":A(d.product_id),options:E.value,class:"custom-multiselect",searchable:!0,"track-by":"id",label:"name",placeholder:l.$t("purchase_orders_page.create_modal.placeholders.select_product"),"selected-label":"","select-label":"","deselect-label":"","onUpdate:modelValue":_=>d.product_id=_?_.id:null},{option:D(({option:_})=>[e("div",gs,[e("span",null,t(_.name),1),!_.stock||_.stock<=0?(c(),u("span",vs," (Sin stock) ")):(c(),u("span",fs," (Stock: "+t(_.stock)+") ",1))])]),singleLabel:D(({option:_})=>[e("div",ys,[e("span",null,t(_.name),1),_.stock!==void 0?(c(),u("span",bs," (Stock: "+t(_.stock)+") ",1)):C("",!0)])]),_:1},8,["model-value","options","placeholder","onUpdate:modelValue"]),l.errors[`items.${g}.product_id`]?(c(),u("div",ws,t(l.errors[`items.${g}.product_id`][0]),1)):C("",!0)]),e("div",xs,[T(e("input",{type:"number","onUpdate:modelValue":_=>d.quantity=_,min:0,class:R(["form-input h-[42px]",{"border-danger":l.errors[`items.${g}.quantity`]}]),placeholder:"Cant.",onInput:_=>B(g,d.quantity),required:""},null,42,ks),[[F,d.quantity,void 0,{number:!0}]])]),l.params.items.length>1?(c(),u("button",{key:0,type:"button",class:"btn btn-outline-danger btn-sm h-[42px] px-3",onClick:_=>l.$emit("remove-item",g)},[...r[8]||(r[8]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])],8,$s)):C("",!0)]),e("div",Cs,[l.errors[`items.${g}.quantity`]?(c(),u("div",Os,t(l.errors[`items.${g}.quantity`][0]),1)):C("",!0),d.product_id?(c(),u("div",{key:1,class:R(["text-xs",a(d.product_id)])}," Stock actual: "+t(I(d.product_id)),3)):C("",!0)]),e("div",Ss,[d.itemNotes&&d.itemNotes.length>0?(c(),u("div",Is,[(c(!0),u(N,null,U(d.itemNotes,_=>{var b;return c(),u("div",{key:_.id,class:"text-xs pb-1 border-b dark:border-gray-600 last:border-b-0"},[e("p",Vs,[z(t((b=_.author)==null?void 0:b.name)+" ",1),e("span",js,"- "+t(k(_.created_at)),1)]),e("p",qs,t(_.note),1)])}),128))])):C("",!0),T(e("input",{type:"text",class:"form-input text-xs",placeholder:l.$t("purchase_orders_page.create_modal.placeholders.item_notes"),"onUpdate:modelValue":_=>d.notes=_},null,8,Ms),[[F,d.notes]])])])]))),128))])]),e("div",Es,[e("label",Ds,t(l.$t("purchase_orders_page.view_modal.fields.notes")),1),e("div",Bs,[(c(!0),u(N,null,U(l.existingOrderNotes,d=>{var g;return c(),u("div",{key:d.id,class:"text-sm pb-2 border-b dark:border-gray-700 last:border-b-0"},[e("p",As,[z(t((g=d.author)==null?void 0:g.name)+" ",1),e("span",Ps,"- "+t(k(d.created_at)),1)]),e("p",Ns,t(d.note),1)])}),128)),!l.existingOrderNotes||l.existingOrderNotes.length===0?(c(),u("div",Us,t(l.$t("user_notes.no_notes_general")),1)):C("",!0)]),e("label",Ls,t(l.$t("purchase_orders_page.create_modal.fields.add_note")),1),T(e("textarea",{id:"notes","onUpdate:modelValue":r[4]||(r[4]=d=>l.params.notes=d),class:"form-textarea min-h-[80px]",placeholder:l.$t("purchase_orders_page.create_modal.placeholders.notes"),rows:"3"},null,8,Ts),[[F,l.params.notes]])]),e("div",Rs,[e("button",{type:"button",class:"btn btn-outline-danger mr-3",onClick:r[5]||(r[5]=d=>S()),disabled:l.saving},t(l.$t("purchase_orders_page.create_modal.buttons.cancel")),9,zs),e("button",{type:"submit",class:"btn btn-primary",disabled:l.saving||!y.value},[l.saving?(c(),u("span",Ks,[r[9]||(r[9]=e("svg",{class:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1)),z(" "+t(l.$t("purchase_orders_page.create_modal.buttons.saving")),1)])):(c(),u("span",Fs,t(l.params.id?l.$t("purchase_orders_page.create_modal.buttons.update"):l.$t("purchase_orders_page.create_modal.buttons.add")),1))],8,Hs)])],32)])])])])):C("",!0)}}),Qs={class:"fixed inset-0 overflow-y-auto"},Ys={class:"flex min-h-full items-center justify-center px-4 py-8"},Js={class:"text-lg font-medium bg-[#fbfbfb] dark:bg-[#121c2c] ltr:pl-5 rtl:pr-5 py-3 ltr:pr-[50px] rtl:pl-[50px]"},Ws={key:0},Xs={key:1,class:"text-gray-500"},Zs={class:"p-5"},et={class:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"},st={class:"space-y-4"},tt={class:"font-semibold text-gray-600"},rt={class:"text-lg"},at={class:"text-sm text-gray-500"},ot={class:"text-sm text-gray-500"},nt={class:"font-semibold text-gray-600"},lt={class:"font-semibold text-gray-600"},dt={class:"text-sm text-gray-500"},it={key:0},ct={class:"font-semibold text-gray-600"},ut={class:"text-lg"},pt={key:1},_t={class:"font-semibold text-gray-600"},mt={class:"flex flex-wrap gap-2"},ht=["onClick"],gt={class:"space-y-4"},vt={class:"font-semibold text-gray-600"},ft={class:"font-semibold text-gray-600"},yt={key:0,class:"text-xs ml-2"},bt={key:1,class:"text-xs ml-2 text-success"},wt={key:0},xt={class:"font-semibold text-gray-600"},kt={key:1},$t={class:"font-semibold text-gray-600"},Ct={class:"text-sm text-gray-500"},Ot={class:"mb-6"},St={class:"text-lg font-semibold mb-4"},It={class:"table-responsive"},Vt={class:"table-striped table-hover"},jt={class:"text-center"},qt={class:"font-semibold"},Mt={class:"text-sm text-gray-500"},Et={class:"mt-2 space-y-2 text-xs"},Dt={class:"font-semibold"},Bt={class:"text-gray-500 text-xs"},At={class:"text-gray-600 dark:text-gray-300"},Pt={key:0,class:"text-gray-500"},Nt={class:"text-center"},Ut={class:"text-center"},Lt={class:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"},Tt={class:"space-y-2"},Rt={class:"mb-2"},zt={class:"font-semibold text-gray-600"},Ht={class:"bg-gray-50 dark:bg-gray-800 p-3 rounded space-y-3"},Kt={class:"font-semibold"},Ft={class:"text-gray-500 text-xs"},Gt={class:"text-gray-600 dark:text-gray-300 whitespace-pre-wrap"},Qt={key:0,class:"text-gray-500"},Yt={key:0},Jt={class:"font-semibold text-danger"},Wt={class:"bg-danger/10 text-danger p-3 rounded"},Xt={class:"flex justify-end items-center mt-8 pt-6 border-t border-gray-200 dark:border-gray-700"},Zt={key:1,class:"text-center py-8"},er={class:"text-gray-500"},sr=ue({__name:"PurchaseOrderViewModal",props:{show:{type:Boolean},order:{}},emits:["close","view-order-id","refresh-view-order"],setup(m,{emit:v}){const O=v,$=a=>({"nuevo pedido":"bg-gray-100 text-gray-800",disponibilidad:"bg-secondary/10 text-secondary","preparar pedido":"bg-success/10 text-success","en preparación":"bg-info/10 text-info",facturación:"bg-primary/10 text-primary","en despacho":"bg-warning/10 text-warning","en ruta":"bg-danger/10 text-danger",entregado:"bg-success/10 text-success"})[a]||"bg-gray-100 text-gray-800",M=a=>!a||a.stock===void 0?"":a.stock===0?"text-danger":a.stock<=(a.reorder_point||0)?"text-warning":"text-success",E=a=>a.expected_delivery_date?new Date(a.expected_delivery_date)<new Date&&a.status!=="received":!1,y=a=>a?new Date(a).toLocaleDateString("es-ES",{year:"numeric",month:"long",day:"numeric"}):"-",B=a=>a?new Date(a).toLocaleString("es-ES",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"",I=()=>{window.print()},A=()=>{console.log("PurchaseOrderViewModal: Emitting close event"),O("close")};return(a,k)=>(c(),Ve(f(De),{appear:"",show:a.show,as:"template"},{default:D(()=>[q(f(qe),{as:"div",onClose:k[3]||(k[3]=S=>a.$emit("close")),class:"relative z-[51]"},{default:D(()=>[q(f(ie),{as:"template",enter:"duration-300 ease-out","enter-from":"opacity-0","enter-to":"opacity-100",leave:"duration-200 ease-in","leave-from":"opacity-100","leave-to":"opacity-0"},{default:D(()=>[q(f(Me),{class:"fixed inset-0 bg-[black]/60"})]),_:1}),e("div",Qs,[e("div",Ys,[q(f(ie),{as:"template",enter:"duration-300 ease-out","enter-from":"opacity-0 scale-95","enter-to":"opacity-100 scale-100",leave:"duration-200 ease-in","leave-from":"opacity-100 scale-100","leave-to":"opacity-0 scale-95"},{default:D(()=>[q(f(Ee),{class:"panel border-0 p-0 rounded-lg overflow-hidden w-full max-w-4xl text-black dark:text-white-dark"},{default:D(()=>{var S,l,r,d,g;return[e("button",{type:"button",class:"absolute top-4 ltr:right-4 rtl:left-4 text-gray-400 hover:text-gray-800 dark:hover:text-gray-600 outline-none",onClick:k[0]||(k[0]=_=>A())},[...k[4]||(k[4]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24px",height:"24px",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"w-6 h-6"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])]),e("div",Js,[z(t(a.$t("purchase_orders_page.view_modal.title"))+" ",1),a.order?(c(),u("span",Ws,t(a.order.order_number),1)):(c(),u("span",Xs,t(a.$t("purchase_orders_page.view_modal.status.loading")),1))]),e("div",Zs,[a.order?(c(),u(N,{key:0},[e("div",et,[e("div",st,[e("div",null,[e("label",tt,t(a.$t("purchase_orders_page.view_modal.fields.supplier"))+": ",1),e("p",rt,t((S=a.order.supplier)==null?void 0:S.name),1),e("p",at,t((l=a.order.supplier)==null?void 0:l.contact_person),1),e("p",ot,t((r=a.order.supplier)==null?void 0:r.email),1)]),e("div",null,[e("label",nt,t(a.$t("purchase_orders_page.view_modal.fields.status"))+": ",1),e("span",{class:R(["badge ml-2",$(a.order.status)])},t(a.$t(`purchase_orders_page.status.${a.order.status.replace(/ /g,"_")}`)),3)]),e("div",null,[e("label",lt,t(a.$t("purchase_orders_page.view_modal.fields.created_by"))+": ",1),e("p",null,t((d=a.order.creator)==null?void 0:d.name),1),e("p",dt,t(y(a.order.created_at)),1)]),a.order.parent?(c(),u("div",it,[e("label",ct,t(a.$t("purchase_orders_page.view_modal.fields.parent_order"))+": ",1),e("p",ut,[e("a",{href:"#",onClick:k[1]||(k[1]=de(_=>a.$emit("view-order-id",a.order.parent.id),["prevent"])),class:"btn btn-outline-info btn-sm"}," #"+t(a.order.parent.order_number),1)])])):C("",!0),a.order.sub_orders&&a.order.sub_orders.length>0?(c(),u("div",pt,[e("label",_t,t(a.$t("purchase_orders_page.view_modal.fields.sub_orders"))+": ",1),e("div",mt,[(c(!0),u(N,null,U(a.order.sub_orders,_=>(c(),u("a",{key:_.id,href:"#",onClick:de(b=>a.$emit("view-order-id",_.id),["prevent"]),class:"btn btn-outline-info btn-sm"}," #"+t(_.order_number),9,ht))),128))])])):C("",!0)]),e("div",gt,[e("div",null,[e("label",vt,t(a.$t("purchase_orders_page.view_modal.fields.order_date"))+": ",1),e("p",null,t(y(a.order.order_date)),1)]),e("div",null,[e("label",ft,t(a.$t("purchase_orders_page.view_modal.fields.expected_delivery"))+": ",1),e("p",{class:R({"text-warning":E(a.order)})},[z(t(y(a.order.expected_delivery_date))+" ",1),E(a.order)?(c(),u("span",yt," ("+t(a.$t("purchase_orders_page.view_modal.delivery_status.delayed"))+") ",1)):a.order.expected_delivery_date?(c(),u("span",bt," ("+t(a.$t("purchase_orders_page.view_modal.delivery_status.on_time"))+") ",1)):C("",!0)],2)]),a.order.delivery_date?(c(),u("div",wt,[e("label",xt,t(a.$t("purchase_orders_page.view_modal.fields.delivery_date"))+": ",1),e("p",null,t(y(a.order.delivery_date)),1)])):C("",!0),a.order.approved_by?(c(),u("div",kt,[e("label",$t,t(a.$t("purchase_orders_page.view_modal.fields.approved_by"))+": ",1),e("p",null,t((g=a.order.approver)==null?void 0:g.name),1),e("p",Ct,t(y(a.order.approved_at)),1)])):C("",!0)])]),e("div",Ot,[e("h3",St,t(a.$t("purchase_orders_page.view_modal.sections.order_items")),1),e("div",It,[e("table",Vt,[e("thead",null,[e("tr",null,[e("th",null,t(a.$t("purchase_orders_page.view_modal.fields.product")),1),e("th",jt,t(a.$t("purchase_orders_page.view_modal.fields.quantity")),1),k[5]||(k[5]=e("th",{class:"text-center"}," Stock Actual ",-1))])]),e("tbody",null,[(c(!0),u(N,null,U(a.order.items,_=>{var b,W,X;return c(),u("tr",{key:_.id},[e("td",null,[e("div",qt,t((b=_.product)==null?void 0:b.name),1),e("div",Mt,t((W=_.product)==null?void 0:W.sku),1),e("div",Et,[(c(!0),u(N,null,U(_.item_notes,H=>{var Z;return c(),u("div",{key:H.id,class:"p-2 rounded bg-gray-100 dark:bg-gray-700"},[e("p",Dt,[z(t((Z=H.author)==null?void 0:Z.name)+" ",1),e("span",Bt,"- "+t(B(H.created_at)),1)]),e("p",At,t(H.note),1)])}),128)),!_.item_notes||_.item_notes.length===0?(c(),u("div",Pt,t(a.$t("user_notes.no_notes_for_item")),1)):C("",!0)])]),e("td",Nt,t(_.quantity),1),e("td",Ut,[e("span",{class:R(M(_.product))},t(((X=_.product)==null?void 0:X.stock)??"-"),3)])])}),128))])])])]),e("div",Lt,[e("div",Tt,[e("div",Rt,[e("label",zt,t(a.$t("purchase_orders_page.view_modal.fields.notes"))+": ",1),e("div",Ht,[(c(!0),u(N,null,U(a.order.notes,_=>{var b;return c(),u("div",{key:_.id,class:"text-sm pb-2 border-b dark:border-gray-700 last:border-b-0"},[e("p",Kt,[z(t((b=_.author)==null?void 0:b.name)+" ",1),e("span",Ft,"- "+t(B(_.created_at)),1)]),e("p",Gt,t(_.note),1)])}),128)),!a.order.notes||a.order.notes.length===0?(c(),u("div",Qt,t(a.$t("user_notes.no_notes_general")),1)):C("",!0)])]),a.order.rejection_reason?(c(),u("div",Yt,[e("label",Jt,t(a.$t("purchase_orders_page.view_modal.fields.rejection_reason"))+": ",1),e("p",Wt,t(a.order.rejection_reason),1)])):C("",!0)])]),e("div",Xt,[e("button",{type:"button",class:"btn btn-outline-primary",onClick:I},[k[6]||(k[6]=e("svg",{class:"w-4 h-4 ltr:mr-2 rtl:ml-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"})],-1)),z(" "+t(a.$t("purchase_orders_page.view_modal.buttons.print")),1)]),e("button",{type:"button",class:"btn btn-outline-danger ltr:ml-4 rtl:mr-4",onClick:k[2]||(k[2]=_=>A())},t(a.$t("purchase_orders_page.view_modal.buttons.close")),1)])],64)):(c(),u("div",Zt,[k[7]||(k[7]=e("div",{class:"animate-spin border-2 border-primary border-t-transparent rounded-full w-8 h-8 mx-auto mb-4"},null,-1)),e("p",er,t(a.$t("purchase_orders_page.view_modal.status.loading")),1)]))])]}),_:1})]),_:1})])])]),_:1})]),_:1},8,["show"]))}}),tr=Pe(sr,[["__scopeId","data-v-2f843438"]]),rr={class:"fixed inset-0 overflow-y-auto"},ar={class:"flex min-h-full items-center justify-center px-4 py-8"},or={class:"text-lg font-bold bg-[#fbfbfb] dark:bg-[#121c2c] ltr:pl-5 rtl:pr-5 py-3 ltr:pr-[50px] rtl:pl-[50px]"},nr={class:"p-5"},lr={class:"mb-5"},dr={for:"expectedDeliveryDate"},ir=["placeholder"],cr={key:0,class:"text-danger mt-1"},ur={class:"mb-5"},pr={key:0},_r={class:"flex items-center justify-between mb-2"},mr={class:"flex-grow"},hr={class:"font-semibold"},gr={class:"w-1/3 ml-4 flex gap-2"},vr=["placeholder","onUpdate:modelValue","max","onInput"],fr=["onClick"],yr=["placeholder","onUpdate:modelValue"],br={key:0,class:"text-danger mt-1 w-full"},wr={key:0,class:"text-danger mt-1"},xr={key:1,class:"text-center text-gray-500"},kr={class:"mb-5"},$r={key:0},Cr={class:"flex items-start justify-between gap-3"},Or={class:"flex-grow"},Sr={class:"flex justify-between items-center w-full"},Ir={class:"flex items-center"},Vr={key:0,class:"text-gray-500 text-xs ml-2"},jr={class:"w-24"},qr=["onUpdate:modelValue"],Mr=["onClick"],Er=["placeholder","onUpdate:modelValue"],Dr={key:1,class:"text-center text-gray-500 text-sm"},Br={class:"mt-8 flex items-center justify-end"},Ar=["disabled"],Pr={key:0},Nr={key:1},Ur=ue({__name:"PurchaseOrderSplitModal",props:{show:{type:Boolean},order:{},products:{},errors:{},saving:{type:Boolean}},emits:["close","split"],setup(m,{emit:v}){const{t:O}=ce(),$=v,M=m,E={expected_delivery_date:"",items:[],newItems:[]},y=Re({...E});ke(()=>M.order,r=>{r&&r.items?(y.items=r.items.map(d=>{var g;return{item_id:d.id,quantity:d.quantity,product_name:((g=d.product)==null?void 0:g.name)||"Unknown Product",original_quantity:d.quantity,notes:""}}).sort((d,g)=>d.product_name.localeCompare(g.product_name)),y.expected_delivery_date="",y.newItems=[]):(y.items=[],y.newItems=[])},{immediate:!0}),ke(()=>M.show,r=>{r||(Object.assign(y,E),y.items=[],y.newItems=[])});const B=(r,d)=>{y.items[r].quantity<0?y.items[r].quantity=0:y.items[r].quantity>d&&(y.items[r].quantity=d)},I=r=>{y.items.splice(r,1)},A=()=>{y.newItems.push({product_id:null,quantity:1,notes:""})},a=r=>{y.newItems.splice(r,1)},k=r=>r&&M.products.find(d=>d.id===r)||null,S=K(()=>{const r=y.items.some(g=>g.quantity&&g.quantity>0),d=y.newItems.some(g=>g.product_id&&g.quantity&&g.quantity>0);return r||d}),l=()=>{const r=y.items.filter(b=>b.quantity>0),d=y.newItems.filter(b=>b.product_id&&b.quantity>0);if(r.length===0&&d.length===0){alert(O("purchase_orders_page.split_modal.alerts.no_items_selected"));return}const _=[...r.map(b=>({item_id:b.item_id,quantity:b.quantity,notes:b.notes})),...d];$("split",{expected_delivery_date:y.expected_delivery_date,items:_})};return(r,d)=>(c(),Ve(f(De),{appear:"",show:r.show,as:"template"},{default:D(()=>[q(f(qe),{as:"div",onClose:d[3]||(d[3]=g=>$("close")),class:"relative z-[51]"},{default:D(()=>[q(f(ie),{as:"template",enter:"duration-300 ease-out","enter-from":"opacity-0","enter-to":"opacity-100",leave:"duration-200 ease-in","leave-from":"opacity-100","leave-to":"opacity-0"},{default:D(()=>[q(f(Me),{class:"fixed inset-0 bg-[black]/60"})]),_:1}),e("div",rr,[e("div",ar,[q(f(ie),{as:"template",enter:"duration-300 ease-out","enter-from":"opacity-0 scale-95","enter-to":"opacity-100 scale-100",leave:"duration-200 ease-in","leave-from":"opacity-100 scale-100","leave-to":"opacity-0 scale-95"},{default:D(()=>[q(f(Ee),{class:"panel border-0 p-0 rounded-lg overflow-hidden w-full max-w-lg text-black dark:text-white-dark"},{default:D(()=>[e("button",{type:"button",class:"absolute top-4 ltr:right-4 rtl:left-4 text-gray-400 hover:text-gray-800 dark:hover:text-gray-600 outline-none",onClick:d[0]||(d[0]=g=>$("close"))},[...d[4]||(d[4]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24px",height:"24px",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"w-6 h-6"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])]),e("div",or,t(f(O)("purchase_orders_page.split_modal.title")),1),e("div",nr,[e("form",{onSubmit:de(l,["prevent"])},[e("div",lr,[e("label",dr,t(f(O)("purchase_orders_page.split_modal.fields.expected_delivery_date")),1),T(e("input",{id:"expectedDeliveryDate",type:"date",placeholder:f(O)("purchase_orders_page.split_modal.placeholders.expected_delivery_date"),class:R(["form-input",[r.errors.expected_delivery_date?"border-danger":""]]),"onUpdate:modelValue":d[1]||(d[1]=g=>y.expected_delivery_date=g)},null,10,ir),[[F,y.expected_delivery_date]]),r.errors.expected_delivery_date?(c(),u("p",cr,t(r.errors.expected_delivery_date[0]),1)):C("",!0)]),e("div",ur,[e("label",null,t(f(O)("purchase_orders_page.split_modal.fields.items_to_split")),1),y.items.length>0?(c(),u("div",pr,[(c(!0),u(N,null,U(y.items,(g,_)=>(c(),u("div",{key:g.item_id,class:"flex flex-col mb-3 border p-3 rounded"},[e("div",_r,[e("div",mr,[e("p",hr,t(g.product_name)+" ("+t(g.original_quantity)+" "+t(f(O)("purchase_orders_page.split_modal.available"))+")",1)]),e("div",gr,[T(e("input",{type:"number",placeholder:f(O)("purchase_orders_page.split_modal.placeholders.quantity_to_split"),class:"form-input","onUpdate:modelValue":b=>g.quantity=b,min:0,max:g.original_quantity,onInput:b=>B(_,g.original_quantity)},null,40,vr),[[F,g.quantity,void 0,{number:!0}]]),e("button",{type:"button",class:"btn btn-outline-danger btn-sm p-2",onClick:b=>I(_)},[...d[5]||(d[5]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])],8,fr)])]),e("div",null,[T(e("input",{type:"text",class:"form-input text-xs",placeholder:f(O)("purchase_orders_page.create_modal.placeholders.item_notes"),"onUpdate:modelValue":b=>g.notes=b},null,8,yr),[[F,g.notes]])]),r.errors[`items.${_}.quantity`]?(c(),u("p",br,t(r.errors[`items.${_}.quantity`][0]),1)):C("",!0)]))),128)),r.errors.items?(c(),u("p",wr,t(r.errors.items[0]),1)):C("",!0)])):(c(),u("div",xr,t(f(O)("purchase_orders_page.split_modal.no_items")),1))]),e("div",kr,[e("div",{class:"flex items-center justify-between mb-2"},[d[6]||(d[6]=e("label",{class:"font-bold"},"Agregar Productos Extra",-1)),e("button",{type:"button",class:"btn btn-primary btn-sm",onClick:A}," + Agregar Item ")]),y.newItems.length>0?(c(),u("div",$r,[(c(!0),u(N,null,U(y.newItems,(g,_)=>(c(),u("div",{key:_,class:"flex flex-col mb-3 border p-3 rounded gap-3"},[e("div",Cr,[e("div",Or,[q(f(je),{"model-value":k(g.product_id),options:r.products,class:"custom-multiselect",searchable:!0,"track-by":"id",label:"name",placeholder:"Seleccionar Producto","selected-label":"","select-label":"","deselect-label":"","onUpdate:modelValue":b=>g.product_id=b?b.id:null},{option:D(({option:b})=>[e("div",Sr,[e("span",null,t(b.name),1),b.stock!==void 0?(c(),u("span",{key:0,class:R([b.stock<=0?"text-danger":"text-success","text-xs ml-2 font-bold"])}," (Stock: "+t(b.stock)+") ",3)):C("",!0)])]),singleLabel:D(({option:b})=>[e("div",Ir,[e("span",null,t(b.name),1),b.stock!==void 0?(c(),u("span",Vr," (Stock: "+t(b.stock)+") ",1)):C("",!0)])]),_:1},8,["model-value","options","onUpdate:modelValue"])]),e("div",jr,[T(e("input",{type:"number",class:"form-input h-[38px]","onUpdate:modelValue":b=>g.quantity=b,min:"1",placeholder:"Cant.",required:""},null,8,qr),[[F,g.quantity,void 0,{number:!0}]])]),e("button",{type:"button",class:"btn btn-outline-danger btn-sm h-[38px] p-2",onClick:b=>a(_)},[...d[7]||(d[7]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"w-5 h-5"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])],8,Mr)]),e("div",null,[T(e("input",{type:"text",class:"form-input text-xs",placeholder:f(O)("purchase_orders_page.create_modal.placeholders.item_notes"),"onUpdate:modelValue":b=>g.notes=b},null,8,Er),[[F,g.notes]])])]))),128))])):(c(),u("div",Dr," No hay productos extra agregados. "))]),e("div",Br,[e("button",{type:"button",class:"btn btn-outline-danger",onClick:d[2]||(d[2]=g=>$("close"))},t(f(O)("purchase_orders_page.split_modal.buttons.cancel")),1),e("button",{type:"submit",class:"btn btn-primary ltr:ml-4 rtl:mr-4",disabled:r.saving||!S.value},[r.saving?(c(),u("span",Pr,t(f(O)("purchase_orders_page.split_modal.buttons.splitting")),1)):(c(),u("span",Nr,t(f(O)("purchase_orders_page.split_modal.buttons.split")),1))],8,Ar)])],32)])]),_:1})]),_:1})])])]),_:1})]),_:1},8,["show"]))}}),Lr={class:"flex space-x-2 rtl:space-x-reverse mb-6"},Tr={href:"javascript:;",class:"text-primary hover:underline"},Rr={class:"before:content-['/'] ltr:before:mr-2 rtl:before:ml-2"},zr={class:"scrumboard-v2 space-y-8"},Hr={class:"flex items-center justify-between flex-wrap gap-4"},Kr={class:"text-xl leading-relaxed"},Fr={class:"flex sm:flex-row flex-col sm:items-center sm:gap-3 gap-4"},Gr={class:"flex gap-3"},Qr={class:"relative pt-5"},Yr={class:"h-full -mx-2"},Jr={key:0,class:"grid place-content-center h-[500px]"},Wr={key:1,class:"overflow-x-auto flex items-start flex-nowrap gap-5 px-2 pb-2"},Xr={class:"flex justify-between mb-5"},Zr={class:"text-base font-semibold"},ea={class:"shadow bg-[#f4f4f4] dark:bg-white-dark/20 p-3 pb-5 rounded-md mb-5 space-y-3 cursor-move"},sa={key:0,class:"flex items-center text-xs text-info font-semibold"},ta={key:1,class:"flex items-center text-xs text-primary font-semibold"},ra={class:"text-base font-medium"},aa={class:"flex items-center text-sm text-gray-500 font-semibold"},oa={class:"break-all text-sm text-gray-700 dark:text-gray-400"},na={class:"flex items-center justify-between text-xs text-gray-500 mt-2"},la={class:"flex justify-end mt-4 gap-2"},da=["onClick"],ia=["onClick"],ca=["onClick"],ua=["onClick"],ka=ue({__name:"OrderKanbanBoard",setup(m){const{t:v}=ce();Ke();const O=He(),$=Ne();Ue({title:v("ordenes.order_kanban_board")});const{fetchSuppliers:M,fetchProducts:E,suppliers:y,products:B,loading:I,saving:A,errorMessage:a,successMessage:k,errors:S,params:l,viewModal:r,orderNotes:d,saveOrder:g,deleteOrder:_,editOrder:b,resetParams:W,viewOrder:X,refreshViewOrderData:H,closeViewModal:Z,addItem:pe,removeItem:ae,showMessage:ee,splitOrder:_e}=Ge(),se=j(!1),te=j(!1),Q=j(null),L=j([{id:"nuevo pedido",title:v("ordenes.status.nuevo_pedido"),badgeClass:"badge-outline-dark",borderColorClass:"border-gray-500",orders:[]},{id:"disponibilidad",title:v("ordenes.status.disponibilidad"),badgeClass:"badge-outline-secondary",borderColorClass:"border-secondary",orders:[]},{id:"preparar pedido",title:v("ordenes.status.preparar_pedido"),badgeClass:"badge-outline-success",borderColorClass:"border-success",orders:[]},{id:"en preparación",title:v("ordenes.status.en_preparacion"),badgeClass:"badge-outline-info",borderColorClass:"border-info",orders:[]},{id:"facturación",title:v("ordenes.status.facturacion"),badgeClass:"badge-outline-primary",borderColorClass:"border-primary",orders:[]},{id:"en despacho",title:v("ordenes.status.en_despacho"),badgeClass:"badge-outline-warning",borderColorClass:"border-warning",orders:[]},{id:"en ruta",title:v("ordenes.status.en_ruta"),badgeClass:"badge-outline-danger",borderColorClass:"border-danger",orders:[]},{id:"entregado",title:v("ordenes.status.entregado"),badgeClass:"badge-outline-success",borderColorClass:"border-success",orders:[]}]),P=async()=>{var h,s;I.value=!0;try{const n=(await V.get("/api/purchase-orders")).data.data;L.value.forEach(i=>{i.orders=[]}),n.forEach(i=>{const p=L.value.find(w=>w.id===i.status);if(p)p.orders.push(i);else{console.warn(`Order ${i.id} has unknown status: ${i.status}. Defaulting to 'nuevo pedido'.`);const w=L.value.find(J=>J.id==="nuevo pedido");w&&w.orders.push(i)}})}catch(o){console.error("Error fetching orders for Kanban:",o);const n=((s=(h=o.response)==null?void 0:h.data)==null?void 0:s.message)||v("ordenes.error_fetching_orders");ee(n,"error")}finally{I.value=!1}},me=async h=>{var Oe,Se;const s=h.item._underlying_vm_.id,o=h.from.dataset.statusId,n=h.to.dataset.statusId;if(!n||!o){console.warn("Source or target status ID is undefined. Drag operation might be invalid. Reverting."),await P();return}const i=L.value.find(G=>G.id===o),p=L.value.find(G=>G.id===n);if(!i||!p){console.warn("Source or target status column not found. Reverting."),await P();return}const w=p.orders.find(G=>G.id===s);if(!w){console.warn(`Order with ID ${s} not found in new status column ${n}. Reverting.`),await P();return}const J=o;try{await V.put(`/api/purchase-orders/${s}/status`,{status:n}),ee(v("ordenes.order_status_updated_successfully"),"success"),w&&(w.status=n)}catch(G){console.error("Error updating order status:",G);const Be=((Se=(Oe=G.response)==null?void 0:Oe.data)==null?void 0:Se.message)||v("ordenes.error_updating_order_status");ee(Be,"error");const Ie=p.orders.findIndex(xe=>xe.id===s);if(Ie!==-1){const xe=p.orders.splice(Ie,1)[0];i.orders.splice(h.oldIndex,0,xe)}w&&(w.status=J),await P()}},he=h=>{const s=["nuevo pedido","disponibilidad","preparar pedido","en preparación"];return!h.parent_id&&s.includes(h.status)},ge=()=>{b(null),se.value=!0},ve=h=>{b(h),se.value=!0},Y=h=>{const s=typeof h=="number"?h:h.id;X(s)},fe=h=>{H(h)},ye=async h=>{await _(h)&&await P()},re=()=>{se.value=!1,W(),P()},oe=async()=>{await g()&&re()},be=h=>{Q.value=h,te.value=!0},ne=()=>{te.value=!1,Q.value=null,S.value={}},x=async h=>{var o;if(!((o=Q.value)!=null&&o.id)){ee(v("purchase_orders_page.split_modal.alerts.no_order_selected"),"error");return}await _e(Q.value.id,h)&&(ne(),await P())},$e=h=>{if(!h)return"";const s={year:"numeric",month:"short",day:"numeric"};return new Date(h).toLocaleDateString(void 0,s)},we=h=>{if(!h)return;let s=null;for(const o of L.value)if(s=o.orders.find(n=>n.id===parseInt(h)),s)break;s&&Y(s)};ze(async()=>{var h;await Promise.all([P(),M(),E()]),we(O.params.orderId),(h=$.user)!=null&&h.id&&window.Echo&&window.Echo.private("orders.board").listen("OrderUpdated",s=>{console.log("Orden actualizada en tiempo real:",s),Ce(s.id,s.status)})});const Ce=(h,s)=>{let o=null,n="";for(const i of L.value){const p=i.orders.findIndex(w=>w.id===h);if(p!==-1){if(o=i.orders[p],n=i.id,n===s)return;i.orders.splice(p,1);break}}if(o){const i=L.value.find(p=>p.id===s);i?(o.status=s,i.orders.unshift(o)):P()}else P()};return ke(()=>O.params.orderId,h=>{h&&we(h)}),(h,s)=>(c(),u("div",null,[e("ul",Lr,[e("li",null,[e("a",Tr,t(h.$t("dashboard")),1)]),e("li",Rr,[e("span",null,t(h.$t("ordenes.kanban_board")),1)])]),e("div",zr,[e("div",Hr,[e("h2",Kr,t(h.$t("ordenes.order_kanban_board")),1),e("div",Fr,[e("div",Gr,[f($).can("create purchase_orders")?(c(),u("button",{key:0,type:"button",class:"btn btn-primary",onClick:ge},[s[2]||(s[2]=e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24px",height:"24px",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"w-5 h-5 ltr:mr-3 rtl:ml-3"},[e("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e("line",{x1:"5",y1:"12",x2:"19",y2:"12"})],-1)),z(" "+t(h.$t("purchase_orders_page.add_order_btn")),1)])):C("",!0),e("button",{type:"button",class:"btn btn-primary",onClick:P},[s[3]||(s[3]=e("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",class:"w-5 h-5"},[e("path",{d:"M20.9999 12C20.9999 16.9706 16.9705 21 11.9999 21C7.02934 21 2.99994 16.9706 2.99994 12C2.99994 7.02944 7.02934 3 11.9999 3",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round"}),e("path",{d:"M18.8477 15.6529C19.7897 14.0533 20.2522 13.0166 20.4939 12",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round"}),e("path",{d:"M17.9999 3L20.9999 7H16.9999",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"})],-1)),z(" "+t(h.$t("ordenes.refresh")),1)])])])]),q(Fe,{"error-message":f(a),"success-message":f(k),onClearError:s[0]||(s[0]=o=>a.value=""),onClearSuccess:s[1]||(s[1]=o=>k.value="")},null,8,["error-message","success-message"]),e("div",Qr,[e("div",Yr,[f(I)?(c(),u("div",Jr,[...s[4]||(s[4]=[e("span",{class:"animate-spin border-4 border-primary border-l-transparent rounded-full w-12 h-12 inline-block align-middle"},null,-1)])])):(c(),u("div",Wr,[(c(!0),u(N,null,U(L.value,o=>(c(),u("div",{key:o.id,class:R(["panel w-80 flex-none border-2 border-solid rounded-lg",o.borderColorClass])},[e("div",Xr,[e("h4",Zr,t(o.title),1),e("span",{class:R(["badge",o.badgeClass])},t(o.orders.length),3)]),q(f(Ae),{class:"connect-sorting-content min-h-[150px]",list:o.orders,group:"kanban-board","ghost-class":"sortable-ghost","drag-class":"sortable-drag",animation:200,onEnd:me,"data-status-id":o.id},{default:D(()=>[(c(!0),u(N,null,U(o.orders,n=>{var i,p;return c(),u("div",{class:"sortable-list",key:n.id},[e("div",ea,[n.parent_id?(c(),u("div",sa,[s[5]||(s[5]=e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"w-4 h-4 mr-1"},[e("polyline",{points:"15 10 20 15 15 20"}),e("path",{d:"M4 4v7a4 4 0 0 0 4 4h12"})],-1)),e("span",null,t(h.$t("ordenes.sub_order")),1)])):C("",!0),n.sub_orders_count>0&&!n.parent_id?(c(),u("div",ta,[...s[6]||(s[6]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"w-4 h-4 mr-1"},[e("path",{d:"M17 2.1l4 4-4 4"}),e("path",{d:"M3 12.6v-2.1c0-4.4 3.6-8 8-8h7"}),e("path",{d:"M7 21.9l-4-4 4-4"}),e("path",{d:"M21 11.4v2.1c0 4.4-3.6 8-8 8H6"})],-1),e("span",null,"Orden Principal",-1)])])):C("",!0),e("div",ra,t(n.order_number)+" - "+t(((i=n.creator)==null?void 0:i.name)||"N/A"),1),e("div",aa,[s[7]||(s[7]=e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"w-3.5 h-3.5 mr-1"},[e("rect",{x:"2",y:"7",width:"20",height:"14",rx:"2",ry:"2"}),e("path",{d:"M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"})],-1)),e("span",null,t(((p=n.supplier)==null?void 0:p.name)||h.$t("purchase_orders_page.kanban.no_supplier")),1)]),e("p",oa,t(n.notes?Array.isArray(n.notes)&&n.notes.length>0?n.notes[0].note:"":h.$t("purchase_orders_page.kanban.no_description")),1),e("div",na,[e("span",null,t(h.$t("ordenes.created_at"))+": "+t($e(n.created_at)),1)]),e("div",la,[e("button",{type:"button",class:"btn btn-outline-info btn-sm",onClick:w=>Y(n)},t(h.$t("ordenes.view_details")),9,da),f($).can("edit purchase_orders")?(c(),u("button",{key:0,type:"button",class:"btn btn-outline-secondary btn-sm",onClick:w=>ve(n)},t(h.$t("edit")),9,ia)):C("",!0),he(n)&&f($).can("create purchase_orders")?(c(),u("button",{key:1,type:"button",class:"btn btn-outline-warning btn-sm",onClick:w=>be(n)},t(h.$t("purchase_orders_page.actions.split")),9,ca)):C("",!0),f($).can("delete purchase_orders")?(c(),u("button",{key:2,type:"button",class:"btn btn-outline-danger btn-sm",onClick:w=>ye(n)},t(h.$t("delete")),9,ua)):C("",!0)])])])}),128))]),_:2},1032,["list","data-status-id"])],2))),128))]))])])]),q(Gs,{show:se.value,params:f(l),errors:f(S),saving:f(A),suppliers:f(y),products:f(B),existingOrderNotes:f(d)||[],onClose:re,onSave:oe,onAddItem:f(pe),onRemoveItem:f(ae)},null,8,["show","params","errors","saving","suppliers","products","existingOrderNotes","onAddItem","onRemoveItem"]),q(tr,{show:f(r).show,order:f(r).data,onClose:f(Z),onViewOrderId:Y,onRefreshViewOrder:fe},null,8,["show","order","onClose"]),q(Ur,{show:te.value,order:Q.value,products:f(B),errors:f(S),saving:f(A),onClose:ne,onSplit:x},null,8,["show","order","products","errors","saving"])]))}});export{ka as default};
