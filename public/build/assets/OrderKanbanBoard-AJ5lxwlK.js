import{r as V,c as K,d as _e,k as u,x as k,l as c,m as e,t,H as ue,A as U,K as Me,n as H,F as N,D as L,a2 as z,y as G,J as Re,f as q,q as B,u as g,I as De,z as ze,w as Oe,o as He,G as Fe,E as Ke}from"./vendor-CjqaLWPm.js";import{V as Ge}from"./vue-draggable-next.esm-bundler-DWdGXwbi.js";import{b as me,d as j,_ as Qe,c as Ye,u as Je}from"./main-BaNU_z7r.js";import{S as ce}from"./sweetalert2.esm.all-5zhdP7Ax.js";import{M as Be}from"./vue3-multiselect-BbInv9yP.js";import{Y as Ae,h as pe,_ as Pe,G as Ue,S as Ne}from"./transition-CBBt4QPa.js";import{_ as We}from"./AlertMessages.vue_vue_type_script_setup_true_lang-CV0GMxpE.js";import"./quill-De1S0mUZ.js";import"./hidden-EHDRiAGA.js";import"./keyboard-DucK85rM.js";import"./open-closed-CzbEUxkg.js";function Xe(){const{t:m}=me(),v=V([]),O=V([]),x=V([]),C=V(!1),D=V(!1),f=V(""),A=V(""),E=V({}),P=V(""),n=V({show:!1,data:null}),$=V(null),S=V({status:"",supplier_id:""}),d={id:null,supplier_id:null,expected_delivery_date:null,notes:"",items:[]},l=V({...d}),i=K(()=>{let s=v.value;if(P.value){const r=P.value.toLowerCase();s=s.filter(a=>{var o,p,b;return((o=a.order_number)==null?void 0:o.toLowerCase().includes(r))||((b=(p=a.supplier)==null?void 0:p.name)==null?void 0:b.toLowerCase().includes(r))})}return S.value.status&&(s=s.filter(r=>r.status===S.value.status)),S.value.supplier_id&&(s=s.filter(r=>r.supplier_id===parseInt(S.value.supplier_id))),s}),h=K(()=>v.value.length),_=K(()=>v.value.filter(s=>s.status==="pending").length),y=K(()=>v.value.filter(s=>s.status==="approved").length),Y=K(()=>v.value.filter(s=>s.status==="ordered").length),X=K(()=>v.value.filter(s=>s.status==="received").length),F=async()=>{C.value=!0,f.value="";try{const s=new URLSearchParams;S.value.status&&s.append("status",S.value.status),S.value.supplier_id&&s.append("supplier_id",S.value.supplier_id);const r=await j.get(`/api/purchase-orders?${s}`);Array.isArray(r.data)?v.value=r.data:r.data&&Array.isArray(r.data.data)?v.value=r.data.data:r.data&&Array.isArray(r.data.orders)?v.value=r.data.orders:(console.warn("Estructura de respuesta inesperada:",r.data),v.value=[])}catch(s){console.error("Error fetching orders:",s),f.value=m("purchase_orders_page.alerts.loading_error"),w(m("purchase_orders_page.alerts.loading_error"),"error")}finally{C.value=!1}},Z=async()=>{try{const s=await j.get("/api/suppliers/for-select");Array.isArray(s.data)?O.value=s.data:s.data&&Array.isArray(s.data.data)?O.value=s.data.data:(console.warn("Estructura de respuesta inesperada para suppliers:",s.data),O.value=[])}catch(s){console.error("Error fetching suppliers:",s),O.value=[]}},he=async()=>{try{const s=await j.get("/api/products/active/list");Array.isArray(s.data)?x.value=s.data:s.data&&Array.isArray(s.data.data)?x.value=s.data.data:(console.warn("Estructura de respuesta inesperada para products:",s.data),x.value=[])}catch(s){console.error("Error fetching products:",s),x.value=[]}},ne=s=>s&&x.value.find(r=>r.id===s)||null,ge=(s,r)=>{if(!s)return{valid:!1,message:"Producto no seleccionado"};const a=ne(s);if(!a)return{valid:!1,message:"Producto no encontrado"};const o=a.current_stock||0;return r>o?{valid:!1,message:`Stock insuficiente. Stock disponible: ${o}`}:{valid:!0,message:""}},J=async()=>{D.value=!0,E.value={},f.value="",A.value="";try{let s;l.value.id?s=await j.put(`/api/purchase-orders/${l.value.id}`,l.value):s=await j.post("/api/purchase-orders",l.value);const r=s.data.data||s.data;if(l.value.id){const a=v.value.findIndex(o=>o.id===l.value.id);a!==-1&&v.value.splice(a,1,r),w(m("purchase_orders_page.alerts.update_success"))}else v.value.unshift(r),w(m("purchase_orders_page.alerts.save_success"));return!0}catch(s){return s.response&&s.response.status===422?(E.value=s.response.data.errors,f.value=m("purchase_orders_page.alerts.validation_errors")):(console.error("Error saving order:",s),f.value=m("purchase_orders_page.alerts.save_error"),w(m("purchase_orders_page.alerts.save_error"),"error")),!1}finally{D.value=!1}},ve=async s=>{var a;if(!s.can_be_deleted)return w(m("purchase_orders_page.alerts.cannot_delete"),"error"),!1;if((await ce.fire({title:m("purchase_orders_page.delete_confirm.title"),text:m("purchase_orders_page.delete_confirm.text"),icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:m("purchase_orders_page.delete_confirm.confirm"),cancelButtonText:m("purchase_orders_page.delete_confirm.cancel")})).isConfirmed)try{return await j.delete(`/api/purchase-orders/${s.id}`),v.value=v.value.filter(o=>o.id!==s.id),w(m("purchase_orders_page.alerts.delete_success")),!0}catch(o){return console.error("Error deleting order:",o),((a=o.response)==null?void 0:a.status)===400?w(o.response.data.message,"error"):w(m("purchase_orders_page.alerts.delete_error"),"error"),!1}return!1},ee=async s=>{var r,a;try{const o=await j.post(`/api/purchase-orders/${s.id}/submit`);if(o.data.success){const p=v.value.findIndex(b=>b.id===s.id);return p!==-1&&v.value.splice(p,1,o.data.order),w(m("purchase_orders_page.alerts.submit_success")),!0}else return w(o.data.message||m("purchase_orders_page.alerts.save_error"),"error"),!1}catch(o){console.error("Error submitting order:",o);const p=((a=(r=o.response)==null?void 0:r.data)==null?void 0:a.message)||m("purchase_orders_page.alerts.save_error");return w(p,"error"),!1}},se=async s=>{var r,a;try{const o=await j.post(`/api/purchase-orders/${s.id}/approve`);if(o.data.success){const p=v.value.findIndex(b=>b.id===s.id);return p!==-1&&v.value.splice(p,1,o.data.order),w(m("purchase_orders_page.alerts.approve_success")),!0}else return w(o.data.message||m("purchase_orders_page.alerts.save_error"),"error"),!1}catch(o){console.error("Error approving order:",o);const p=((a=(r=o.response)==null?void 0:r.data)==null?void 0:a.message)||m("purchase_orders_page.alerts.save_error");return w(p,"error"),!1}},W=async s=>{var a,o;const{value:r}=await ce.fire({title:m("purchase_orders_page.reject_confirm.title"),input:"textarea",inputLabel:m("purchase_orders_page.reject_confirm.input_label"),inputPlaceholder:m("purchase_orders_page.reject_confirm.input_placeholder"),inputAttributes:{"aria-label":m("purchase_orders_page.reject_confirm.input_label")},showCancelButton:!0,confirmButtonText:m("purchase_orders_page.reject_confirm.confirm"),cancelButtonText:m("purchase_orders_page.reject_confirm.cancel"),inputValidator:p=>p?null:m("purchase_orders_page.reject_confirm.input_required")});if(r)try{const p=await j.post(`/api/purchase-orders/${s.id}/reject`,{rejection_reason:r});if(p.data.success){const b=v.value.findIndex(I=>I.id===s.id);return b!==-1&&v.value.splice(b,1,p.data.order),w(m("purchase_orders_page.alerts.reject_success")),!0}else return w(p.data.message||m("purchase_orders_page.alerts.save_error"),"error"),!1}catch(p){console.error("Error rejecting order:",p);const b=((o=(a=p.response)==null?void 0:a.data)==null?void 0:o.message)||m("purchase_orders_page.alerts.save_error");return w(b,"error"),!1}return!1},T=async s=>{var r,a;try{const o=await j.post(`/api/purchase-orders/${s.id}/mark-ordered`);if(o.data.success){const p=v.value.findIndex(b=>b.id===s.id);return p!==-1&&v.value.splice(p,1,o.data.order),w(m("purchase_orders_page.alerts.mark_ordered_success")),!0}else return w(o.data.message||m("purchase_orders_page.alerts.save_error"),"error"),!1}catch(o){console.error("Error marking order as ordered:",o);const p=((a=(r=o.response)==null?void 0:r.data)==null?void 0:a.message)||m("purchase_orders_page.alerts.save_error");return w(p,"error"),!1}},M=async s=>{var r,a;try{const o=await j.post(`/api/purchase-orders/${s.id}/receive`);if(o.data.success){const p=v.value.findIndex(b=>b.id===s.id);return p!==-1&&v.value.splice(p,1,o.data.order),w(m("purchase_orders_page.alerts.receive_success")),!0}else return w(o.data.message||m("purchase_orders_page.alerts.save_error"),"error"),!1}catch(o){console.error("Error receiving order:",o);const p=((a=(r=o.response)==null?void 0:r.data)==null?void 0:a.message)||m("purchase_orders_page.alerts.save_error");return w(p,"error"),!1}},fe=async s=>{var a,o;const{value:r}=await ce.fire({title:m("purchase_orders_page.cancel_confirm.title"),input:"textarea",inputLabel:m("purchase_orders_page.cancel_confirm.input_label"),inputPlaceholder:m("purchase_orders_page.cancel_confirm.input_placeholder"),showCancelButton:!0,confirmButtonText:m("purchase_orders_page.cancel_confirm.confirm"),cancelButtonText:m("purchase_orders_page.cancel_confirm.cancel")});if(r!==void 0)try{const p=await j.post(`/api/purchase-orders/${s.id}/cancel`,{reason:r||null});if(p.data.success){const b=v.value.findIndex(I=>I.id===s.id);return b!==-1&&v.value.splice(b,1,p.data.order),w(m("purchase_orders_page.alerts.cancel_success")),!0}else return w(p.data.message||m("purchase_orders_page.alerts.save_error"),"error"),!1}catch(p){console.error("Error canceling order:",p);const b=((o=(a=p.response)==null?void 0:a.data)==null?void 0:o.message)||m("purchase_orders_page.alerts.save_error");return w(b,"error"),!1}return!1},ye=async s=>{var r,a;try{const o=await j.post(`/api/purchase-orders/${s.id}/reopen`);if(o.data.success){const p=v.value.findIndex(b=>b.id===s.id);return p!==-1&&v.value.splice(p,1,o.data.order),w(m("purchase_orders_page.alerts.reopen_success")),!0}else return w(o.data.message||m("purchase_orders_page.alerts.save_error"),"error"),!1}catch(o){console.error("Error reopening order:",o);const p=((a=(r=o.response)==null?void 0:r.data)==null?void 0:a.message)||m("purchase_orders_page.alerts.save_error");return w(p,"error"),!1}},be=async(s,r)=>{D.value=!0,E.value={},f.value="",A.value="";try{const a=await j.post(`/api/purchase-orders/${s}/split`,r);return a.data?(await F(),w(m("purchase_orders_page.alerts.split_success")),!0):(w(a.data.message||m("purchase_orders_page.alerts.split_error"),"error"),!1)}catch(a){return a.response&&a.response.status===422?(E.value=a.response.data.errors,f.value=m("purchase_orders_page.alerts.validation_errors")):(console.error("Error splitting order:",a),f.value=m("purchase_orders_page.alerts.split_error"),w(m("purchase_orders_page.alerts.split_error"),"error")),!1}finally{D.value=!1}},te=async s=>{C.value=!0;try{return(await j.get(`/api/purchase-orders/${s}`)).data}catch(r){return console.error("Error fetching order details:",r),w(m("purchase_orders_page.alerts.loading_error"),"error"),null}finally{C.value=!1}},re=async(s=null)=>{var r;if(E.value={},s){const a=await te(s.id);if(!a)return;$.value=a.notes;const o=a.expected_delivery_date?new Date(a.expected_delivery_date).toISOString().split("T")[0]:null;l.value={id:a.id,supplier_id:a.supplier_id,expected_delivery_date:o,items:((r=a.items)==null?void 0:r.map(p=>({id:p.id,product_id:p.product_id,quantity:p.quantity,itemNotes:p.item_notes||[],notes:"",checked:p.checked??!1})))||[]}}else $.value=null,l.value={...d,items:[le()]}},we=()=>{l.value={...d},$.value=null,E.value={}},le=()=>({product_id:null,quantity:1,itemNotes:[],checked:!1}),ae=()=>{l.value.items.push(le())},xe=s=>{l.value.items.splice(s,1),l.value.items.length===0&&ae()},$e=s=>({draft:"bg-gray-100 text-gray-800",pending:"bg-warning/10 text-warning",approved:"bg-success/10 text-success",rejected:"bg-danger/10 text-danger",ordered:"bg-info/10 text-info",received:"bg-secondary/10 text-secondary",cancelled:"bg-danger/10 text-danger"})[s]||"bg-gray-100 text-gray-800",w=(s="",r="success")=>{r==="success"?A.value=s:f.value=s,ce.mixin({toast:!0,position:"top",showConfirmButton:!1,timer:3e3}).fire({icon:r,title:s,padding:"10px 20px"})};return{ordersList:v,suppliers:O,products:x,loading:C,saving:D,errorMessage:f,successMessage:A,errors:E,searchOrder:P,filters:S,params:l,viewModal:n,orderNotes:$,filteredOrdersList:i,totalOrders:h,pendingOrders:_,approvedOrders:y,orderedOrders:Y,receivedOrders:X,fetchOrders:F,fetchSuppliers:Z,fetchProducts:he,getProductInfo:ne,validateQuantity:ge,saveOrder:J,deleteOrder:ve,submitOrder:ee,approveOrder:se,rejectOrder:W,markAsOrdered:T,receiveOrder:M,cancelOrder:fe,reopenOrder:ye,editOrder:re,resetParams:we,addItem:ae,removeItem:xe,getStatusClass:$e,showMessage:w,formatDate:s=>s?new Date(s).toLocaleDateString("es-ES"):"-",viewOrder:async s=>{n.value={show:!0,data:null};const r=await te(s);r?n.value.data=r:n.value.show=!1},refreshViewOrderData:async s=>{const r=await te(s);r&&(n.value.data=r)},closeViewModal:()=>{n.value={show:!1,data:null}},splitOrder:be}}const Ze={key:0,class:"fixed inset-0 bg-[black]/60 z-50 overflow-y-auto"},es={class:"flex items-start justify-center min-h-screen px-4"},ss={class:"panel border-0 p-0 rounded-lg overflow-hidden w-full max-w-6xl my-8"},ts={class:"flex bg-[#fbfbfb] dark:bg-[#1c232f] items-center justify-between px-5 py-3"},rs={class:"font-bold text-lg"},as={class:"p-5"},os={class:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-5"},ns={for:"supplier",class:"form-label"},ls={value:""},ds=["value"],is={key:0,class:"text-danger mt-1 text-xs"},cs={for:"expected_delivery_date",class:"form-label"},us={key:0,class:"text-danger mt-1 text-xs"},ps={class:"mb-5"},_s={class:"flex justify-between items-center mb-3"},ms={class:"form-label"},hs={class:"space-y-4"},gs={class:"flex flex-col gap-3"},vs={class:"flex items-start gap-3"},fs={class:"pt-2"},ys=["onUpdate:modelValue"],bs={class:"flex-grow"},ws={class:"flex justify-between items-center w-full"},xs={key:0,class:"text-danger text-xs font-bold ml-2"},$s={key:1,class:"text-success text-xs ml-2"},ks={class:"flex items-center"},Cs={key:0,class:"text-gray-500 text-xs ml-2"},Os={key:0,class:"text-danger mt-1 text-xs"},Ss={class:"w-24"},Is=["onUpdate:modelValue","onInput"],Vs=["onClick"],js={class:"pl-8"},qs={key:0,class:"text-danger text-xs mb-1"},Es={class:"pl-8"},Ms={key:0,class:"bg-gray-100 dark:bg-gray-700 p-2 rounded space-y-2 max-h-24 overflow-y-auto mb-2"},Ds={class:"font-semibold"},Bs={class:"text-gray-500 text-xs"},As={class:"text-gray-600 dark:text-gray-300 whitespace-pre-wrap"},Ps=["placeholder","onUpdate:modelValue"],Us={class:"mb-5"},Ns={class:"form-label font-semibold"},Ls={class:"bg-gray-50 dark:bg-gray-800 p-3 rounded space-y-3 mb-3"},Ts={class:"font-semibold"},Rs={class:"text-gray-500 text-xs"},zs={class:"text-gray-600 dark:text-gray-300 whitespace-pre-wrap"},Hs={key:0,class:"text-gray-500"},Fs={for:"notes",class:"form-label text-xs"},Ks=["placeholder"],Gs={class:"flex justify-end items-center mt-8 border-t pt-4"},Qs=["disabled"],Ys=["disabled"],Js={key:0,class:"flex items-center"},Ws={key:1},Xs=_e({__name:"PurchaseOrderModal",props:{show:{type:Boolean},params:{},errors:{},saving:{type:Boolean},suppliers:{},products:{},existingOrderNotes:{}},emits:["close","save","add-item","remove-item","refresh-view-order"],setup(m,{emit:v}){const{t:O}=me(),x=m,C=v,D=K(()=>x.products.filter(d=>d.is_active!==!1)),f=K(()=>x.params.items.length>0&&x.params.items.every(l=>l.product_id&&l.quantity>0)),A=(d,l)=>{l===""||l===null||l<0&&(x.params.items[d].quantity=0)},E=d=>{if(!d)return 0;const l=x.products.find(i=>i.id===d);return(l==null?void 0:l.stock)||0},P=d=>d&&x.products.find(l=>l.id===d)||null,n=d=>{if(!d)return"";const l=x.products.find(i=>i.id===d);return l?l.stock===0?"text-danger":l.stock<=(l.reorder_point||0)?"text-warning":"text-success":""},$=d=>d?new Date(d).toLocaleDateString("es-ES",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"-",S=()=>{console.log("PurchaseOrderModal: Emitting close event"),C("close")};return(d,l)=>d.show?(c(),u("div",Ze,[e("div",es,[e("div",ss,[e("div",ts,[e("h5",rs,t(d.params.id?d.$t("purchase_orders_page.create_modal.edit_title"):d.$t("purchase_orders_page.create_modal.add_title")),1),e("button",{type:"button",class:"text-white-dark hover:text-dark",onClick:l[0]||(l[0]=i=>S())},[...l[7]||(l[7]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"w-6 h-6"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])])]),e("div",as,[e("form",{onSubmit:l[6]||(l[6]=ue(i=>d.$emit("save",d.params),["prevent"]))},[e("div",os,[e("div",null,[e("label",ns,t(d.$t("purchase_orders_page.create_modal.fields.supplier")),1),U(e("select",{id:"supplier","onUpdate:modelValue":l[1]||(l[1]=i=>d.params.supplier_id=i),class:H(["form-select",{"border-danger":d.errors.supplier_id}])},[e("option",ls,t(d.$t("purchase_orders_page.create_modal.placeholders.select_supplier")),1),(c(!0),u(N,null,L(d.suppliers,i=>(c(),u("option",{key:i.id,value:i.id},t(i.name),9,ds))),128))],2),[[Me,d.params.supplier_id]]),d.errors.supplier_id?(c(),u("div",is,t(d.errors.supplier_id[0]),1)):k("",!0)]),e("div",null,[e("label",cs,t(d.$t("purchase_orders_page.create_modal.fields.expected_delivery_date")),1),U(e("input",{id:"expected_delivery_date",type:"date","onUpdate:modelValue":l[2]||(l[2]=i=>d.params.expected_delivery_date=i),class:H(["form-input",{"border-danger":d.errors.expected_delivery_date}])},null,2),[[z,d.params.expected_delivery_date]]),d.errors.expected_delivery_date?(c(),u("div",us,t(d.errors.expected_delivery_date[0]),1)):k("",!0)])]),e("div",ps,[e("div",_s,[e("label",ms,t(d.$t("purchase_orders_page.create_modal.fields.items"))+" * ",1),e("button",{type:"button",class:"btn btn-primary btn-sm",onClick:l[3]||(l[3]=i=>d.$emit("add-item"))}," + "+t(d.$t("purchase_orders_page.create_modal.buttons.add_item")),1)]),e("div",hs,[(c(!0),u(N,null,L(d.params.items,(i,h)=>(c(),u("div",{key:h,class:"border border-[#e0e6ed] dark:border-[#1b2e4b] rounded p-4 bg-gray-50 dark:bg-[#1a2234]"},[e("div",gs,[e("div",vs,[e("div",fs,[U(e("input",{type:"checkbox",class:"form-checkbox w-5 h-5","onUpdate:modelValue":_=>i.checked=_},null,8,ys),[[Re,i.checked]])]),e("div",bs,[q(g(Be),{"model-value":P(i.product_id),options:D.value,class:"custom-multiselect",searchable:!0,"track-by":"id",label:"name",placeholder:d.$t("purchase_orders_page.create_modal.placeholders.select_product"),"selected-label":"","select-label":"","deselect-label":"","onUpdate:modelValue":_=>i.product_id=_?_.id:null},{option:B(({option:_})=>[e("div",ws,[e("span",null,t(_.name),1),!_.stock||_.stock<=0?(c(),u("span",xs," (Sin stock) ")):(c(),u("span",$s," (Stock: "+t(_.stock)+") ",1))])]),singleLabel:B(({option:_})=>[e("div",ks,[e("span",null,t(_.name),1),_.stock!==void 0?(c(),u("span",Cs," (Stock: "+t(_.stock)+") ",1)):k("",!0)])]),_:1},8,["model-value","options","placeholder","onUpdate:modelValue"]),d.errors[`items.${h}.product_id`]?(c(),u("div",Os,t(d.errors[`items.${h}.product_id`][0]),1)):k("",!0)]),e("div",Ss,[U(e("input",{type:"number","onUpdate:modelValue":_=>i.quantity=_,min:0,step:"any",class:H(["form-input h-[42px]",{"border-danger":d.errors[`items.${h}.quantity`]}]),placeholder:"Cant.",onInput:_=>A(h,i.quantity),required:""},null,42,Is),[[z,i.quantity,void 0,{number:!0}]])]),d.params.items.length>1?(c(),u("button",{key:0,type:"button",class:"btn btn-outline-danger btn-sm h-[42px] px-3",onClick:_=>d.$emit("remove-item",h)},[...l[8]||(l[8]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])],8,Vs)):k("",!0)]),e("div",js,[d.errors[`items.${h}.quantity`]?(c(),u("div",qs,t(d.errors[`items.${h}.quantity`][0]),1)):k("",!0),i.product_id?(c(),u("div",{key:1,class:H(["text-xs",n(i.product_id)])}," Stock actual: "+t(E(i.product_id)),3)):k("",!0)]),e("div",Es,[i.itemNotes&&i.itemNotes.length>0?(c(),u("div",Ms,[(c(!0),u(N,null,L(i.itemNotes,_=>{var y;return c(),u("div",{key:_.id,class:"text-xs pb-1 border-b dark:border-gray-600 last:border-b-0"},[e("p",Ds,[G(t((y=_.author)==null?void 0:y.name)+" ",1),e("span",Bs,"- "+t($(_.created_at)),1)]),e("p",As,t(_.note),1)])}),128))])):k("",!0),U(e("input",{type:"text",class:"form-input text-xs",placeholder:d.$t("purchase_orders_page.create_modal.placeholders.item_notes"),"onUpdate:modelValue":_=>i.notes=_},null,8,Ps),[[z,i.notes]])])])]))),128))])]),e("div",Us,[e("label",Ns,t(d.$t("purchase_orders_page.view_modal.fields.notes")),1),e("div",Ls,[(c(!0),u(N,null,L(d.existingOrderNotes,i=>{var h;return c(),u("div",{key:i.id,class:"text-sm pb-2 border-b dark:border-gray-700 last:border-b-0"},[e("p",Ts,[G(t((h=i.author)==null?void 0:h.name)+" ",1),e("span",Rs,"- "+t($(i.created_at)),1)]),e("p",zs,t(i.note),1)])}),128)),!d.existingOrderNotes||d.existingOrderNotes.length===0?(c(),u("div",Hs,t(d.$t("user_notes.no_notes_general")),1)):k("",!0)]),e("label",Fs,t(d.$t("purchase_orders_page.create_modal.fields.add_note")),1),U(e("textarea",{id:"notes","onUpdate:modelValue":l[4]||(l[4]=i=>d.params.notes=i),class:"form-textarea min-h-[80px]",placeholder:d.$t("purchase_orders_page.create_modal.placeholders.notes"),rows:"3"},null,8,Ks),[[z,d.params.notes]])]),e("div",Gs,[e("button",{type:"button",class:"btn btn-outline-danger mr-3",onClick:l[5]||(l[5]=i=>S()),disabled:d.saving},t(d.$t("purchase_orders_page.create_modal.buttons.cancel")),9,Qs),e("button",{type:"submit",class:"btn btn-primary",disabled:d.saving||!f.value},[d.saving?(c(),u("span",Js,[l[9]||(l[9]=e("svg",{class:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1)),G(" "+t(d.$t("purchase_orders_page.create_modal.buttons.saving")),1)])):(c(),u("span",Ws,t(d.params.id?d.$t("purchase_orders_page.create_modal.buttons.update"):d.$t("purchase_orders_page.create_modal.buttons.add")),1))],8,Ys)])],32)])])])])):k("",!0)}}),Zs={class:"fixed inset-0 overflow-y-auto"},et={class:"flex min-h-full items-center justify-center px-4 py-8"},st={class:"text-lg font-medium bg-[#fbfbfb] dark:bg-[#121c2c] ltr:pl-5 rtl:pr-5 py-3 ltr:pr-[50px] rtl:pl-[50px]"},tt={key:0},rt={key:1,class:"text-gray-500"},at={class:"p-5"},ot={class:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"},nt={class:"space-y-4"},lt={class:"font-semibold text-gray-600"},dt={class:"text-lg"},it={class:"text-sm text-gray-500"},ct={class:"text-sm text-gray-500"},ut={class:"font-semibold text-gray-600"},pt={class:"font-semibold text-gray-600"},_t={class:"text-sm text-gray-500"},mt={key:0},ht={class:"font-semibold text-gray-600"},gt={class:"text-lg"},vt={key:1},ft={class:"font-semibold text-gray-600"},yt={class:"flex flex-wrap gap-2"},bt=["onClick"],wt={class:"space-y-4"},xt={class:"font-semibold text-gray-600"},$t={class:"font-semibold text-gray-600"},kt={key:0,class:"text-xs ml-2"},Ct={key:1,class:"text-xs ml-2 text-success"},Ot={key:0},St={class:"font-semibold text-gray-600"},It={key:1},Vt={class:"font-semibold text-gray-600"},jt={class:"text-sm text-gray-500"},qt={class:"mb-6"},Et={class:"text-lg font-semibold mb-4"},Mt={class:"table-responsive"},Dt={class:"table-striped table-hover"},Bt={class:"text-center"},At={class:"font-semibold"},Pt={class:"text-sm text-gray-500"},Ut={class:"mt-2 space-y-2 text-xs"},Nt={class:"font-semibold"},Lt={class:"text-gray-500 text-xs"},Tt={class:"text-gray-600 dark:text-gray-300"},Rt={key:0,class:"text-gray-500"},zt={class:"text-center"},Ht={class:"text-center"},Ft={class:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"},Kt={class:"space-y-2"},Gt={class:"mb-2"},Qt={class:"font-semibold text-gray-600"},Yt={class:"bg-gray-50 dark:bg-gray-800 p-3 rounded space-y-3"},Jt={class:"font-semibold"},Wt={class:"text-gray-500 text-xs"},Xt={class:"text-gray-600 dark:text-gray-300 whitespace-pre-wrap"},Zt={key:0,class:"text-gray-500"},er={key:0},sr={class:"font-semibold text-danger"},tr={class:"bg-danger/10 text-danger p-3 rounded"},rr={class:"flex justify-end items-center mt-8 pt-6 border-t border-gray-200 dark:border-gray-700"},ar={key:1,class:"text-center py-8"},or={class:"text-gray-500"},nr=_e({__name:"PurchaseOrderViewModal",props:{show:{type:Boolean},order:{}},emits:["close","view-order-id","refresh-view-order"],setup(m,{emit:v}){const O=v,x=n=>({"nuevo pedido":"bg-gray-100 text-gray-800",disponibilidad:"bg-secondary/10 text-secondary","preparar pedido":"bg-success/10 text-success","en preparación":"bg-info/10 text-info",facturación:"bg-primary/10 text-primary","en despacho":"bg-warning/10 text-warning","en ruta":"bg-danger/10 text-danger",entregado:"bg-success/10 text-success"})[n]||"bg-gray-100 text-gray-800",C=n=>!n||n.stock===void 0?"":n.stock===0?"text-danger":n.stock<=(n.reorder_point||0)?"text-warning":"text-success",D=n=>n.expected_delivery_date?new Date(n.expected_delivery_date)<new Date&&n.status!=="received":!1,f=n=>n?new Date(n).toLocaleDateString("es-ES",{year:"numeric",month:"long",day:"numeric"}):"-",A=n=>n?new Date(n).toLocaleString("es-ES",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"",E=()=>{window.print()},P=()=>{console.log("PurchaseOrderViewModal: Emitting close event"),O("close")};return(n,$)=>(c(),De(g(Ne),{appear:"",show:n.show,as:"template"},{default:B(()=>[q(g(Ae),{as:"div",onClose:$[3]||($[3]=S=>n.$emit("close")),class:"relative z-[51]"},{default:B(()=>[q(g(pe),{as:"template",enter:"duration-300 ease-out","enter-from":"opacity-0","enter-to":"opacity-100",leave:"duration-200 ease-in","leave-from":"opacity-100","leave-to":"opacity-0"},{default:B(()=>[q(g(Pe),{class:"fixed inset-0 bg-[black]/60"})]),_:1}),e("div",Zs,[e("div",et,[q(g(pe),{as:"template",enter:"duration-300 ease-out","enter-from":"opacity-0 scale-95","enter-to":"opacity-100 scale-100",leave:"duration-200 ease-in","leave-from":"opacity-100 scale-100","leave-to":"opacity-0 scale-95"},{default:B(()=>[q(g(Ue),{class:"panel border-0 p-0 rounded-lg overflow-hidden w-full max-w-4xl text-black dark:text-white-dark"},{default:B(()=>{var S,d,l,i,h;return[e("button",{type:"button",class:"absolute top-4 ltr:right-4 rtl:left-4 text-gray-400 hover:text-gray-800 dark:hover:text-gray-600 outline-none",onClick:$[0]||($[0]=_=>P())},[...$[4]||($[4]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24px",height:"24px",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"w-6 h-6"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])]),e("div",st,[G(t(n.$t("purchase_orders_page.view_modal.title"))+" ",1),n.order?(c(),u("span",tt,t(n.order.order_number),1)):(c(),u("span",rt,t(n.$t("purchase_orders_page.view_modal.status.loading")),1))]),e("div",at,[n.order?(c(),u(N,{key:0},[e("div",ot,[e("div",nt,[e("div",null,[e("label",lt,t(n.$t("purchase_orders_page.view_modal.fields.supplier"))+": ",1),e("p",dt,t((S=n.order.supplier)==null?void 0:S.name),1),e("p",it,t((d=n.order.supplier)==null?void 0:d.contact_person),1),e("p",ct,t((l=n.order.supplier)==null?void 0:l.email),1)]),e("div",null,[e("label",ut,t(n.$t("purchase_orders_page.view_modal.fields.status"))+": ",1),e("span",{class:H(["badge ml-2",x(n.order.status)])},t(n.$t(`purchase_orders_page.status.${n.order.status.replace(/ /g,"_")}`)),3)]),e("div",null,[e("label",pt,t(n.$t("purchase_orders_page.view_modal.fields.created_by"))+": ",1),e("p",null,t((i=n.order.creator)==null?void 0:i.name),1),e("p",_t,t(f(n.order.created_at)),1)]),n.order.parent?(c(),u("div",mt,[e("label",ht,t(n.$t("purchase_orders_page.view_modal.fields.parent_order"))+": ",1),e("p",gt,[e("a",{href:"#",onClick:$[1]||($[1]=ue(_=>n.$emit("view-order-id",n.order.parent.id),["prevent"])),class:"btn btn-outline-info btn-sm"}," #"+t(n.order.parent.order_number),1)])])):k("",!0),n.order.sub_orders&&n.order.sub_orders.length>0?(c(),u("div",vt,[e("label",ft,t(n.$t("purchase_orders_page.view_modal.fields.sub_orders"))+": ",1),e("div",yt,[(c(!0),u(N,null,L(n.order.sub_orders,_=>(c(),u("a",{key:_.id,href:"#",onClick:ue(y=>n.$emit("view-order-id",_.id),["prevent"]),class:"btn btn-outline-info btn-sm"}," #"+t(_.order_number),9,bt))),128))])])):k("",!0)]),e("div",wt,[e("div",null,[e("label",xt,t(n.$t("purchase_orders_page.view_modal.fields.order_date"))+": ",1),e("p",null,t(f(n.order.order_date)),1)]),e("div",null,[e("label",$t,t(n.$t("purchase_orders_page.view_modal.fields.expected_delivery"))+": ",1),e("p",{class:H({"text-warning":D(n.order)})},[G(t(f(n.order.expected_delivery_date))+" ",1),D(n.order)?(c(),u("span",kt," ("+t(n.$t("purchase_orders_page.view_modal.delivery_status.delayed"))+") ",1)):n.order.expected_delivery_date?(c(),u("span",Ct," ("+t(n.$t("purchase_orders_page.view_modal.delivery_status.on_time"))+") ",1)):k("",!0)],2)]),n.order.delivery_date?(c(),u("div",Ot,[e("label",St,t(n.$t("purchase_orders_page.view_modal.fields.delivery_date"))+": ",1),e("p",null,t(f(n.order.delivery_date)),1)])):k("",!0),n.order.approved_by?(c(),u("div",It,[e("label",Vt,t(n.$t("purchase_orders_page.view_modal.fields.approved_by"))+": ",1),e("p",null,t((h=n.order.approver)==null?void 0:h.name),1),e("p",jt,t(f(n.order.approved_at)),1)])):k("",!0)])]),e("div",qt,[e("h3",Et,t(n.$t("purchase_orders_page.view_modal.sections.order_items")),1),e("div",Mt,[e("table",Dt,[e("thead",null,[e("tr",null,[e("th",null,t(n.$t("purchase_orders_page.view_modal.fields.product")),1),e("th",Bt,t(n.$t("purchase_orders_page.view_modal.fields.quantity")),1),$[5]||($[5]=e("th",{class:"text-center"}," Stock Actual ",-1))])]),e("tbody",null,[(c(!0),u(N,null,L(n.order.items,_=>{var y,Y,X;return c(),u("tr",{key:_.id},[e("td",null,[e("div",At,t((y=_.product)==null?void 0:y.name),1),e("div",Pt,t((Y=_.product)==null?void 0:Y.sku),1),e("div",Ut,[(c(!0),u(N,null,L(_.item_notes,F=>{var Z;return c(),u("div",{key:F.id,class:"p-2 rounded bg-gray-100 dark:bg-gray-700"},[e("p",Nt,[G(t((Z=F.author)==null?void 0:Z.name)+" ",1),e("span",Lt,"- "+t(A(F.created_at)),1)]),e("p",Tt,t(F.note),1)])}),128)),!_.item_notes||_.item_notes.length===0?(c(),u("div",Rt,t(n.$t("user_notes.no_notes_for_item")),1)):k("",!0)])]),e("td",zt,t(_.quantity),1),e("td",Ht,[e("span",{class:H(C(_.product))},t(((X=_.product)==null?void 0:X.stock)??"-"),3)])])}),128))])])])]),e("div",Ft,[e("div",Kt,[e("div",Gt,[e("label",Qt,t(n.$t("purchase_orders_page.view_modal.fields.notes"))+": ",1),e("div",Yt,[(c(!0),u(N,null,L(n.order.notes,_=>{var y;return c(),u("div",{key:_.id,class:"text-sm pb-2 border-b dark:border-gray-700 last:border-b-0"},[e("p",Jt,[G(t((y=_.author)==null?void 0:y.name)+" ",1),e("span",Wt,"- "+t(A(_.created_at)),1)]),e("p",Xt,t(_.note),1)])}),128)),!n.order.notes||n.order.notes.length===0?(c(),u("div",Zt,t(n.$t("user_notes.no_notes_general")),1)):k("",!0)])]),n.order.rejection_reason?(c(),u("div",er,[e("label",sr,t(n.$t("purchase_orders_page.view_modal.fields.rejection_reason"))+": ",1),e("p",tr,t(n.order.rejection_reason),1)])):k("",!0)])]),e("div",rr,[e("button",{type:"button",class:"btn btn-outline-primary",onClick:E},[$[6]||($[6]=e("svg",{class:"w-4 h-4 ltr:mr-2 rtl:ml-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"})],-1)),G(" "+t(n.$t("purchase_orders_page.view_modal.buttons.print")),1)]),e("button",{type:"button",class:"btn btn-outline-danger ltr:ml-4 rtl:mr-4",onClick:$[2]||($[2]=_=>P())},t(n.$t("purchase_orders_page.view_modal.buttons.close")),1)])],64)):(c(),u("div",ar,[$[7]||($[7]=e("div",{class:"animate-spin border-2 border-primary border-t-transparent rounded-full w-8 h-8 mx-auto mb-4"},null,-1)),e("p",or,t(n.$t("purchase_orders_page.view_modal.status.loading")),1)]))])]}),_:1})]),_:1})])])]),_:1})]),_:1},8,["show"]))}}),lr=Qe(nr,[["__scopeId","data-v-2f843438"]]),dr={class:"fixed inset-0 overflow-y-auto"},ir={class:"flex min-h-full items-center justify-center px-4 py-8"},cr={class:"text-lg font-bold bg-[#fbfbfb] dark:bg-[#121c2c] ltr:pl-5 rtl:pr-5 py-3 ltr:pr-[50px] rtl:pl-[50px]"},ur={class:"p-5"},pr={class:"mb-5"},_r={for:"expectedDeliveryDate"},mr=["placeholder"],hr={key:0,class:"text-danger mt-1"},gr={class:"mb-5"},vr={key:0},fr={class:"flex items-center justify-between mb-2"},yr={class:"flex-grow"},br={class:"font-semibold"},wr={class:"w-1/3 ml-4 flex gap-2"},xr=["placeholder","onUpdate:modelValue","max","onInput"],$r=["onClick"],kr=["placeholder","onUpdate:modelValue"],Cr={key:0,class:"text-danger mt-1 w-full"},Or={key:0,class:"text-danger mt-1"},Sr={key:1,class:"text-center text-gray-500"},Ir={class:"mb-5"},Vr={key:0},jr={class:"flex items-start justify-between gap-3"},qr={class:"flex-grow"},Er={class:"flex justify-between items-center w-full"},Mr={class:"flex items-center"},Dr={key:0,class:"text-gray-500 text-xs ml-2"},Br={class:"w-24"},Ar=["onUpdate:modelValue"],Pr=["onClick"],Ur=["placeholder","onUpdate:modelValue"],Nr={key:1,class:"text-center text-gray-500 text-sm"},Lr={class:"mt-8 flex items-center justify-end"},Tr=["disabled"],Rr={key:0},zr={key:1},Hr=_e({__name:"PurchaseOrderSplitModal",props:{show:{type:Boolean},order:{},products:{},errors:{},saving:{type:Boolean}},emits:["close","split"],setup(m,{emit:v}){const{t:O}=me(),x=v,C=m,D={expected_delivery_date:"",items:[],newItems:[]},f=ze({...D});Oe(()=>C.order,l=>{l&&l.items?(f.items=l.items.map(i=>{var h;return{item_id:i.id,quantity:i.quantity,product_name:((h=i.product)==null?void 0:h.name)||"Unknown Product",original_quantity:i.quantity,notes:""}}).sort((i,h)=>i.product_name.localeCompare(h.product_name)),f.expected_delivery_date="",f.newItems=[]):(f.items=[],f.newItems=[])},{immediate:!0}),Oe(()=>C.show,l=>{l||(Object.assign(f,D),f.items=[],f.newItems=[])});const A=(l,i)=>{f.items[l].quantity<0?f.items[l].quantity=0:f.items[l].quantity>i&&(f.items[l].quantity=i)},E=l=>{f.items.splice(l,1)},P=()=>{f.newItems.push({product_id:null,quantity:1,notes:""})},n=l=>{f.newItems.splice(l,1)},$=l=>l&&C.products.find(i=>i.id===l)||null,S=K(()=>{const l=f.items.some(h=>h.quantity&&h.quantity>0),i=f.newItems.some(h=>h.product_id&&h.quantity&&h.quantity>0);return l||i}),d=()=>{const l=f.items.filter(y=>y.quantity>0),i=f.newItems.filter(y=>y.product_id&&y.quantity>0);if(l.length===0&&i.length===0){alert(O("purchase_orders_page.split_modal.alerts.no_items_selected"));return}const _=[...l.map(y=>({item_id:y.item_id,quantity:y.quantity,notes:y.notes})),...i];x("split",{expected_delivery_date:f.expected_delivery_date,items:_})};return(l,i)=>(c(),De(g(Ne),{appear:"",show:l.show,as:"template"},{default:B(()=>[q(g(Ae),{as:"div",onClose:i[3]||(i[3]=h=>x("close")),class:"relative z-[51]"},{default:B(()=>[q(g(pe),{as:"template",enter:"duration-300 ease-out","enter-from":"opacity-0","enter-to":"opacity-100",leave:"duration-200 ease-in","leave-from":"opacity-100","leave-to":"opacity-0"},{default:B(()=>[q(g(Pe),{class:"fixed inset-0 bg-[black]/60"})]),_:1}),e("div",dr,[e("div",ir,[q(g(pe),{as:"template",enter:"duration-300 ease-out","enter-from":"opacity-0 scale-95","enter-to":"opacity-100 scale-100",leave:"duration-200 ease-in","leave-from":"opacity-100 scale-100","leave-to":"opacity-0 scale-95"},{default:B(()=>[q(g(Ue),{class:"panel border-0 p-0 rounded-lg overflow-hidden w-full max-w-lg text-black dark:text-white-dark"},{default:B(()=>[e("button",{type:"button",class:"absolute top-4 ltr:right-4 rtl:left-4 text-gray-400 hover:text-gray-800 dark:hover:text-gray-600 outline-none",onClick:i[0]||(i[0]=h=>x("close"))},[...i[4]||(i[4]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24px",height:"24px",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"w-6 h-6"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])]),e("div",cr,t(g(O)("purchase_orders_page.split_modal.title")),1),e("div",ur,[e("form",{onSubmit:ue(d,["prevent"])},[e("div",pr,[e("label",_r,t(g(O)("purchase_orders_page.split_modal.fields.expected_delivery_date")),1),U(e("input",{id:"expectedDeliveryDate",type:"date",placeholder:g(O)("purchase_orders_page.split_modal.placeholders.expected_delivery_date"),class:H(["form-input",[l.errors.expected_delivery_date?"border-danger":""]]),"onUpdate:modelValue":i[1]||(i[1]=h=>f.expected_delivery_date=h)},null,10,mr),[[z,f.expected_delivery_date]]),l.errors.expected_delivery_date?(c(),u("p",hr,t(l.errors.expected_delivery_date[0]),1)):k("",!0)]),e("div",gr,[e("label",null,t(g(O)("purchase_orders_page.split_modal.fields.items_to_split")),1),f.items.length>0?(c(),u("div",vr,[(c(!0),u(N,null,L(f.items,(h,_)=>(c(),u("div",{key:h.item_id,class:"flex flex-col mb-3 border p-3 rounded"},[e("div",fr,[e("div",yr,[e("p",br,t(h.product_name)+" ("+t(h.original_quantity)+" "+t(g(O)("purchase_orders_page.split_modal.available"))+")",1)]),e("div",wr,[U(e("input",{type:"number",placeholder:g(O)("purchase_orders_page.split_modal.placeholders.quantity_to_split"),class:"form-input","onUpdate:modelValue":y=>h.quantity=y,min:0,max:h.original_quantity,step:"any",onInput:y=>A(_,h.original_quantity)},null,40,xr),[[z,h.quantity,void 0,{number:!0}]]),e("button",{type:"button",class:"btn btn-outline-danger btn-sm p-2",onClick:y=>E(_)},[...i[5]||(i[5]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])],8,$r)])]),e("div",null,[U(e("input",{type:"text",class:"form-input text-xs",placeholder:g(O)("purchase_orders_page.create_modal.placeholders.item_notes"),"onUpdate:modelValue":y=>h.notes=y},null,8,kr),[[z,h.notes]])]),l.errors[`items.${_}.quantity`]?(c(),u("p",Cr,t(l.errors[`items.${_}.quantity`][0]),1)):k("",!0)]))),128)),l.errors.items?(c(),u("p",Or,t(l.errors.items[0]),1)):k("",!0)])):(c(),u("div",Sr,t(g(O)("purchase_orders_page.split_modal.no_items")),1))]),e("div",Ir,[e("div",{class:"flex items-center justify-between mb-2"},[i[6]||(i[6]=e("label",{class:"font-bold"},"Agregar Productos Extra",-1)),e("button",{type:"button",class:"btn btn-primary btn-sm",onClick:P}," + Agregar Item ")]),f.newItems.length>0?(c(),u("div",Vr,[(c(!0),u(N,null,L(f.newItems,(h,_)=>(c(),u("div",{key:_,class:"flex flex-col mb-3 border p-3 rounded gap-3"},[e("div",jr,[e("div",qr,[q(g(Be),{"model-value":$(h.product_id),options:l.products,class:"custom-multiselect",searchable:!0,"track-by":"id",label:"name",placeholder:"Seleccionar Producto","selected-label":"","select-label":"","deselect-label":"","onUpdate:modelValue":y=>h.product_id=y?y.id:null},{option:B(({option:y})=>[e("div",Er,[e("span",null,t(y.name),1),y.stock!==void 0?(c(),u("span",{key:0,class:H([y.stock<=0?"text-danger":"text-success","text-xs ml-2 font-bold"])}," (Stock: "+t(y.stock)+") ",3)):k("",!0)])]),singleLabel:B(({option:y})=>[e("div",Mr,[e("span",null,t(y.name),1),y.stock!==void 0?(c(),u("span",Dr," (Stock: "+t(y.stock)+") ",1)):k("",!0)])]),_:1},8,["model-value","options","onUpdate:modelValue"])]),e("div",Br,[U(e("input",{type:"number",class:"form-input h-[38px]","onUpdate:modelValue":y=>h.quantity=y,min:"0.01",step:"any",placeholder:"Cant.",required:""},null,8,Ar),[[z,h.quantity,void 0,{number:!0}]])]),e("button",{type:"button",class:"btn btn-outline-danger btn-sm h-[38px] p-2",onClick:y=>n(_)},[...i[7]||(i[7]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"w-5 h-5"},[e("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])],8,Pr)]),e("div",null,[U(e("input",{type:"text",class:"form-input text-xs",placeholder:g(O)("purchase_orders_page.create_modal.placeholders.item_notes"),"onUpdate:modelValue":y=>h.notes=y},null,8,Ur),[[z,h.notes]])])]))),128))])):(c(),u("div",Nr," No hay productos extra agregados. "))]),e("div",Lr,[e("button",{type:"button",class:"btn btn-outline-danger",onClick:i[2]||(i[2]=h=>x("close"))},t(g(O)("purchase_orders_page.split_modal.buttons.cancel")),1),e("button",{type:"submit",class:"btn btn-primary ltr:ml-4 rtl:mr-4",disabled:l.saving||!S.value},[l.saving?(c(),u("span",Rr,t(g(O)("purchase_orders_page.split_modal.buttons.splitting")),1)):(c(),u("span",zr,t(g(O)("purchase_orders_page.split_modal.buttons.split")),1))],8,Tr)])],32)])]),_:1})]),_:1})])])]),_:1})]),_:1},8,["show"]))}}),Fr={class:"scrumboard-v2 space-y-8"},Kr={class:"flex items-center justify-between flex-wrap gap-4"},Gr={class:"text-xl leading-relaxed"},Qr={class:"panel mb-5"},Yr={class:"flex flex-col md:flex-row justify-between items-end gap-4"},Jr={class:"flex flex-col sm:flex-row items-end gap-4 flex-none"},Wr={class:"w-full sm:w-64"},Xr={class:"text-xs font-bold mb-1"},Zr={value:""},ea=["value"],sa={class:"w-full sm:w-44"},ta={class:"text-xs font-bold mb-1"},ra={class:"w-full sm:w-44"},aa={class:"text-xs font-bold mb-1"},oa={class:"flex-none w-full md:w-auto"},na={class:"relative pt-5"},la={class:"h-full -mx-2"},da={key:0,class:"grid place-content-center h-[500px]"},ia={key:1,class:"overflow-x-auto flex items-start flex-nowrap gap-5 px-2 pb-2"},ca={class:"flex justify-between mb-5"},ua={class:"text-base font-semibold"},pa={class:"shadow bg-[#f4f4f4] dark:bg-white-dark/20 p-3 pb-5 rounded-md mb-5 space-y-3 cursor-move"},_a={key:0,class:"flex items-center text-xs text-info font-semibold"},ma={key:1,class:"flex items-center text-xs text-primary font-semibold"},ha={class:"text-base font-medium"},ga={class:"flex items-center text-sm text-gray-500 font-semibold"},va={class:"break-all text-sm text-gray-700 dark:text-gray-400"},fa={class:"flex items-center justify-between text-xs text-gray-500 mt-2"},ya={class:"flex justify-end mt-4 gap-2"},ba=["onClick"],wa=["onClick"],xa=["onClick"],$a=["onClick"],Ba=_e({__name:"OrderKanbanBoard",setup(m){const{t:v}=me();Ke();const O=Fe(),x=Ye();Je({title:v("ordenes.order_kanban_board")});const C=V({search:"",supplier_id:"",date_from:"",date_to:""}),{fetchSuppliers:D,fetchProducts:f,suppliers:A,products:E,loading:P,saving:n,errorMessage:$,successMessage:S,errors:d,params:l,viewModal:i,orderNotes:h,saveOrder:_,deleteOrder:y,editOrder:Y,resetParams:X,viewOrder:F,refreshViewOrderData:Z,closeViewModal:he,addItem:ne,removeItem:ge,showMessage:J,splitOrder:ve}=Xe(),ee=V(!1),se=V(!1),W=V(null),T=V([{id:"nuevo pedido",title:v("ordenes.status.nuevo_pedido"),badgeClass:"badge-outline-dark",borderColorClass:"border-gray-500",orders:[]},{id:"disponibilidad",title:v("ordenes.status.disponibilidad"),badgeClass:"badge-outline-secondary",borderColorClass:"border-secondary",orders:[]},{id:"preparar pedido",title:v("ordenes.status.preparar_pedido"),badgeClass:"badge-outline-success",borderColorClass:"border-success",orders:[]},{id:"en preparación",title:v("ordenes.status.en_preparacion"),badgeClass:"badge-outline-info",borderColorClass:"border-info",orders:[]},{id:"facturación",title:v("ordenes.status.facturacion"),badgeClass:"badge-outline-primary",borderColorClass:"border-primary",orders:[]},{id:"en despacho",title:v("ordenes.status.en_despacho"),badgeClass:"badge-outline-warning",borderColorClass:"border-warning",orders:[]},{id:"en ruta",title:v("ordenes.status.en_ruta"),badgeClass:"badge-outline-danger",borderColorClass:"border-danger",orders:[]},{id:"entregado",title:v("ordenes.status.entregado"),badgeClass:"badge-outline-success",borderColorClass:"border-success",orders:[]}]),M=async()=>{var s,r;P.value=!0;try{const a=new URLSearchParams;C.value.search&&a.append("search",C.value.search),C.value.supplier_id&&a.append("supplier_id",C.value.supplier_id),C.value.date_from&&a.append("date_from",C.value.date_from),C.value.date_to&&a.append("date_to",C.value.date_to);const p=(await j.get(`/api/purchase-orders?${a.toString()}`)).data.data;T.value.forEach(b=>{b.orders=[]}),p.forEach(b=>{const I=T.value.find(Q=>Q.id===b.status);if(I)I.orders.push(b);else{console.warn(`Order ${b.id} has unknown status: ${b.status}. Defaulting to 'nuevo pedido'.`);const Q=T.value.find(de=>de.id==="nuevo pedido");Q&&Q.orders.push(b)}})}catch(a){console.error("Error fetching orders for Kanban:",a);const o=((r=(s=a.response)==null?void 0:s.data)==null?void 0:r.message)||v("ordenes.error_fetching_orders");J(o,"error")}finally{P.value=!1}},fe=async s=>{var je,qe;const r=s.item._underlying_vm_.id,a=s.from.dataset.statusId,o=s.to.dataset.statusId;if(!o||!a){console.warn("Source or target status ID is undefined. Drag operation might be invalid. Reverting."),await M();return}if(a===o)return;const p=["nuevo pedido","disponibilidad","preparar pedido","en preparación","facturación","en despacho","en ruta","entregado"],b=p.indexOf(a),I=p.indexOf(o),Q=p.indexOf("facturación");if(b>=Q&&I<b&&I!==-1&&!x.can("override_order_restrictions")){J(v("ordenes.cannot_move_back_after_billing"),"error"),await M();return}const de=T.value.find(R=>R.id===a),ie=T.value.find(R=>R.id===o);if(!de||!ie){console.warn("Source or target status column not found. Reverting."),await M();return}const oe=ie.orders.find(R=>R.id===r);if(!oe){console.warn(`Order with ID ${r} not found in new status column ${o}. Reverting.`),await M();return}const Le=a;try{const R=await j.put(`/api/purchase-orders/${r}/status`,{status:o});J(v("ordenes.order_status_updated_successfully"),"success"),oe&&R.data.order&&Object.assign(oe,R.data.order)}catch(R){console.error("Error updating order status:",R);const Te=((qe=(je=R.response)==null?void 0:je.data)==null?void 0:qe.message)||v("ordenes.error_updating_order_status");J(Te,"error");const Ee=ie.orders.findIndex(Ce=>Ce.id===r);if(Ee!==-1){const Ce=ie.orders.splice(Ee,1)[0];de.orders.splice(s.oldIndex,0,Ce)}oe&&(oe.status=Le),await M()}},ye=s=>{const r=["nuevo pedido","disponibilidad","preparar pedido","en preparación"];return!s.parent_id&&r.includes(s.status)},be=()=>{Y(null),ee.value=!0},te=s=>{Y(s),ee.value=!0},re=s=>{const r=typeof s=="number"?s:s.id;F(r)},we=s=>{Z(s)},le=async s=>{await y(s)&&await M()},ae=()=>{ee.value=!1,X(),M()},xe=async()=>{await _()&&ae()},$e=s=>{W.value=s,se.value=!0},w=()=>{se.value=!1,W.value=null,d.value={}},Se=async s=>{var a;if(!((a=W.value)!=null&&a.id)){J(v("purchase_orders_page.split_modal.alerts.no_order_selected"),"error");return}await ve(W.value.id,s)&&(w(),await M())},Ie=s=>{if(!s)return"";const r={year:"numeric",month:"short",day:"numeric"};return new Date(s).toLocaleDateString(void 0,r)},ke=s=>{if(!s)return;let r=null;for(const a of T.value)if(r=a.orders.find(o=>o.id===parseInt(s)),r)break;r&&re(r)};He(async()=>{var s;await Promise.all([M(),D(),f()]),ke(O.params.orderId),(s=x.user)!=null&&s.id&&window.Echo&&window.Echo.private("orders.board").listen("OrderUpdated",r=>{console.log("Orden actualizada en tiempo real:",r),r.order&&Ve(r.order)})});const Ve=s=>{const r=s.id,a=s.status;let o=null,p="";for(const b of T.value){const I=b.orders.findIndex(Q=>Q.id===r);if(I!==-1){if(o=b.orders[I],p=b.id,Object.assign(o,s),p===a)return;b.orders.splice(I,1);break}}if(o){const b=T.value.find(I=>I.id===a);b?b.orders.unshift(o):M()}else M()};return Oe(()=>O.params.orderId,s=>{s&&ke(s)}),(s,r)=>(c(),u("div",null,[e("div",Fr,[e("div",Kr,[e("h2",Gr,t(s.$t("ordenes.order_kanban_board")),1)]),e("div",Qr,[e("div",Yr,[e("div",Jr,[e("div",Wr,[e("label",Xr,t(s.$t("purchase_orders_page.table.supplier")),1),U(e("select",{"onUpdate:modelValue":r[0]||(r[0]=a=>C.value.supplier_id=a),class:"form-select",onChange:M},[e("option",Zr,t(s.$t("purchase_orders_page.filters.all_suppliers")),1),(c(!0),u(N,null,L(g(A),a=>(c(),u("option",{key:a.id,value:a.id},t(a.name),9,ea))),128))],544),[[Me,C.value.supplier_id]])]),e("div",sa,[e("label",ta,t(s.$t("calendar_page.from")),1),U(e("input",{type:"date","onUpdate:modelValue":r[1]||(r[1]=a=>C.value.date_from=a),class:"form-input",onChange:M},null,544),[[z,C.value.date_from]])]),e("div",ra,[e("label",aa,t(s.$t("calendar_page.to")),1),U(e("input",{type:"date","onUpdate:modelValue":r[2]||(r[2]=a=>C.value.date_to=a),class:"form-input",onChange:M},null,544),[[z,C.value.date_to]])])]),e("div",oa,[g(x).can("create purchase_orders")?(c(),u("button",{key:0,type:"button",class:"btn btn-primary w-full md:w-auto",onClick:be},[r[5]||(r[5]=e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24px",height:"24px",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"w-5 h-5 ltr:mr-2 rtl:ml-2"},[e("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e("line",{x1:"5",y1:"12",x2:"19",y2:"12"})],-1)),G(" "+t(s.$t("purchase_orders_page.add_order_btn")),1)])):k("",!0)])])]),q(We,{"error-message":g($),"success-message":g(S),onClearError:r[3]||(r[3]=a=>$.value=""),onClearSuccess:r[4]||(r[4]=a=>S.value="")},null,8,["error-message","success-message"]),e("div",na,[e("div",la,[g(P)?(c(),u("div",da,[...r[6]||(r[6]=[e("span",{class:"animate-spin border-4 border-primary border-l-transparent rounded-full w-12 h-12 inline-block align-middle"},null,-1)])])):(c(),u("div",ia,[(c(!0),u(N,null,L(T.value,a=>(c(),u("div",{key:a.id,class:H(["panel w-80 flex-none border-2 border-solid rounded-lg",a.borderColorClass])},[e("div",ca,[e("h4",ua,t(a.title),1),e("span",{class:H(["badge",a.badgeClass])},t(a.orders.length),3)]),q(g(Ge),{class:"connect-sorting-content min-h-[150px]",list:a.orders,group:"kanban-board","ghost-class":"sortable-ghost","drag-class":"sortable-drag",animation:200,onEnd:fe,"data-status-id":a.id},{default:B(()=>[(c(!0),u(N,null,L(a.orders,o=>{var p,b;return c(),u("div",{class:"sortable-list",key:o.id},[e("div",pa,[o.parent_id?(c(),u("div",_a,[r[7]||(r[7]=e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"w-4 h-4 mr-1"},[e("polyline",{points:"15 10 20 15 15 20"}),e("path",{d:"M4 4v7a4 4 0 0 0 4 4h12"})],-1)),e("span",null,t(s.$t("ordenes.sub_order")),1)])):k("",!0),o.sub_orders_count>0&&!o.parent_id?(c(),u("div",ma,[...r[8]||(r[8]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"w-4 h-4 mr-1"},[e("path",{d:"M17 2.1l4 4-4 4"}),e("path",{d:"M3 12.6v-2.1c0-4.4 3.6-8 8-8h7"}),e("path",{d:"M7 21.9l-4-4 4-4"}),e("path",{d:"M21 11.4v2.1c0 4.4-3.6 8-8 8H6"})],-1),e("span",null,"Orden Principal",-1)])])):k("",!0),e("div",ha,t(o.order_number)+" - "+t(((p=o.creator)==null?void 0:p.name)||"N/A"),1),e("div",ga,[r[9]||(r[9]=e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"w-3.5 h-3.5 mr-1"},[e("rect",{x:"2",y:"7",width:"20",height:"14",rx:"2",ry:"2"}),e("path",{d:"M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"})],-1)),e("span",null,t(((b=o.supplier)==null?void 0:b.name)||s.$t("purchase_orders_page.kanban.no_supplier")),1)]),e("p",va,t(o.notes?Array.isArray(o.notes)&&o.notes.length>0?o.notes[0].note:"":s.$t("purchase_orders_page.kanban.no_description")),1),e("div",fa,[e("span",null,t(s.$t("ordenes.created_at"))+": "+t(Ie(o.created_at)),1)]),e("div",ya,[e("button",{type:"button",class:"btn btn-outline-info btn-sm",onClick:I=>re(o)},t(s.$t("ordenes.view_details")),9,ba),g(x).can("edit purchase_orders")&&(o.can_be_edited||g(x).can("override_order_restrictions"))?(c(),u("button",{key:0,type:"button",class:"btn btn-outline-secondary btn-sm",onClick:I=>te(o)},t(s.$t("edit")),9,wa)):k("",!0),g(x).can("create purchase_orders")&&(ye(o)||g(x).can("override_order_restrictions"))?(c(),u("button",{key:1,type:"button",class:"btn btn-outline-warning btn-sm",onClick:I=>$e(o)},t(s.$t("purchase_orders_page.actions.split")),9,xa)):k("",!0),g(x).can("delete purchase_orders")&&(o.can_be_deleted||g(x).can("override_order_restrictions"))?(c(),u("button",{key:2,type:"button",class:"btn btn-outline-danger btn-sm",onClick:I=>le(o)},t(s.$t("delete")),9,$a)):k("",!0)])])])}),128))]),_:2},1032,["list","data-status-id"])],2))),128))]))])])]),q(Xs,{show:ee.value,params:g(l),errors:g(d),saving:g(n),suppliers:g(A),products:g(E),existingOrderNotes:g(h)||[],onClose:ae,onSave:xe,onAddItem:g(ne),onRemoveItem:g(ge)},null,8,["show","params","errors","saving","suppliers","products","existingOrderNotes","onAddItem","onRemoveItem"]),q(lr,{show:g(i).show,order:g(i).data,onClose:g(he),onViewOrderId:re,onRefreshViewOrder:we},null,8,["show","order","onClose"]),q(Hr,{show:se.value,order:W.value,products:g(E),errors:g(d),saving:g(n),onClose:w,onSplit:Se},null,8,["show","order","products","errors","saving"])]))}});export{Ba as default};
